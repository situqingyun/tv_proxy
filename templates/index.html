<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <title>TradingView - Advanced Charts</title>

    <!-- Socket.IO for WebSocket communications -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Use the correct static path -->
    <script src="charting_library/charting_library.standalone.js"></script>
    <!-- <script src="datafeeds/udf/dist/bundle.js"></script> -->
    <script type="text/javascript" src="datafeeds/tv-datafeed.js"></script>
    <script>
        function getParameterByName(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)'),
                results = regex.exec(location.search);
            return results === null
                ? ''
                : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        const codeSvg = (style) => `<svg style="${style}" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.93556 4.5061L3.43556 8.5061L3.00342 8.99998L3.43556 9.49386L6.93556 13.4939L8.06443 12.5061L4.99657 8.99998L8.06443 5.49386L6.93556 4.5061ZM11.0644 13.4939L14.5644 9.49386L14.9966 8.99998L14.5644 8.5061L11.0644 4.5061L9.93556 5.49386L13.0034 8.99998L9.93556 12.5061L11.0644 13.4939Z" fill="currentColor"/></svg>`;
        const customCSS = `#documentation-toolbar-button {
				all: unset;
				position: relative;
				color: #FFF;
				font-size: 14px;
				font-weight: 400;
				line-height: 18px;
				letter-spacing: 0.15408px;
				padding: 5px 12px;
				border-radius: 80px;
				background: #2962FF;
				cursor: pointer;
			}
			#documentation-toolbar-button:hover {
				background: #1E53E5;
			}
			#documentation-toolbar-button:active {
				background: #1948CC;
			}
			#theme-toggle {
				display: flex;
				flex-direction: row;
				align-items: center;
				gap: 12px;
			}
			.switcher {
				display: inline-block;
				position: relative;
				flex: 0 0 auto;
				width: 38px;
				height: 20px;
				vertical-align: middle;
				z-index: 0;
				-webkit-tap-highlight-color: transparent;
			}

			.switcher input {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				opacity: 0;
				z-index: 1;
				cursor: default;
			}

			.switcher .thumb-wrapper {
				display: block;
				border-radius: 20px;
				position: relative;
				z-index: 0;
				width: 100%;
				height: 100%;
			}

			.switcher .track {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				border-radius: 20px;
				background-color: #a3a6af;
			}

			#theme-switch:checked + .thumb-wrapper .track {
				background-color: #2962ff;
			}

			.switcher .thumb {
				display: block;
				width: 14px;
				height: 14px;
				border-radius: 14px;
				transition-duration: 250ms;
				transition-property: transform;
				transition-timing-function: ease-out;
				transform: translate(3px, 3px);
				background: #ffffff;
			}

			[dir=rtl] .switcher .thumb {
				transform: translate(-3px, 3px);
			}

			.switcher input:checked + .thumb-wrapper .thumb {
				transform: translate(21px, 3px);
			}

			[dir=rtl] .switcher input:checked + .thumb-wrapper .thumb {
				transform: translate(-21px, 3px);
			}

			#documentation-toolbar-button:focus-visible:before,
			.switcher:focus-within:before {
				content: '';
				display: block;
				position: absolute;
				top: -2px;
				right: -2px;
				bottom: -2px;
				left: -2px;
				border-radius: 16px;
				outline: #2962FF solid 2px;
			}`;
        function initOnReady() {
            // Create a proxy for WebSocket to intercept connections
            const originalWebSocket = window.WebSocket;
            let socketProxy;
            let proxyUrl;

            // Fetch the WebSocket proxy URL from our server
            fetch('/ws-proxy-url')
                .then(response => response.json())
                .then(data => {
                    proxyUrl = data.proxyUrl;
                    console.log('Using WebSocket proxy:', proxyUrl);
                })
                .catch(error => {
                    console.error('Failed to get WebSocket proxy URL:', error);
                });
                
            // Override the WebSocket constructor with a proper proxy implementation
            window.WebSocket = function(url, protocols) {
                console.log('WebSocket connection intercepted:', url);
                
                if (url.includes('widgetdata.tradingview.com') || url.includes('tradingview.com')) {
                    // Create a fake WebSocket instance that will delegate to our Socket.IO proxy
                    const fakeWs = {};
                    
                    // Store the connection ID we'll receive from the server
                    let connectionId = null;
                    
                    // Create Socket.IO connection to our proxy server if not already connected
                    if (!socketProxy) {
                        socketProxy = io();
                        
                        socketProxy.on('connect', () => {
                            console.log('Connected to WebSocket proxy server');
                        });
                        
                        socketProxy.on('disconnect', () => {
                            console.log('Disconnected from WebSocket proxy server');
                        });
                    }
                    
                    // Initialize connection to TradingView via our proxy
                    socketProxy.emit('tv_ws_connect', {url: url});
                    
                    // Handle the connection ID response
                    socketProxy.on('tv_ws_connected', (data) => {
                        connectionId = data.connectionId;
                        console.log('WebSocket proxy connection established with ID:', connectionId);
                        // Trigger onopen when connected to TradingView
                        if (fakeWs.onopen) {
                            fakeWs.onopen();
                        }
                    });
                    
                    // Handle incoming messages from TradingView
                    socketProxy.on('tv_message', (data) => {
                        if (fakeWs.onmessage) {
                            fakeWs.onmessage({data: data.message, origin: proxyUrl || window.location.origin});
                        }
                    });
                    
                    // Handle connection close
                    socketProxy.on('tv_disconnect', () => {
                        if (fakeWs.onclose) {
                            fakeWs.onclose({code: 1000, reason: 'Normal closure', wasClean: true});
                        }
                    });
                    
                    // Handle errors
                    socketProxy.on('tv_error', (data) => {
                        if (fakeWs.onerror) {
                            fakeWs.onerror(data.error);
                        }
                    });
                    
                    // Implement the WebSocket interface
                    fakeWs.send = function(data) {
                        socketProxy.emit('tv_ws_send', {connectionId: connectionId, message: data});
                    };
                    
                    fakeWs.close = function() {
                        socketProxy.emit('tv_ws_disconnect', {connectionId: connectionId});
                    };
                    
                    // Set WebSocket readyState properties
                    fakeWs.CONNECTING = 0;
                    fakeWs.OPEN = 1;
                    fakeWs.CLOSING = 2;
                    fakeWs.CLOSED = 3;
                    fakeWs.readyState = fakeWs.CONNECTING;
                    
                    // Update readyState on events
                    socketProxy.on('tv_connect', () => {
                        fakeWs.readyState = fakeWs.OPEN;
                    });
                    
                    socketProxy.on('tv_disconnect', () => {
                        fakeWs.readyState = fakeWs.CLOSED;
                    });
                    
                    return fakeWs;
                } else {
                    // For non-TradingView WebSockets, use the original implementation
                    return new originalWebSocket(url, protocols);
                }
            };
            
            // Keep WebSocket prototype methods
            window.WebSocket.prototype = originalWebSocket.prototype;

            // Initialize TradingView chart
            let setDemoDatafeedStatus = undefined;
            class CustomDatafeed extends TradingViewDatafeed.TradingViewDatafeed {
                resolveSymbol() {
                    if (setDemoDatafeedStatus) {
                        setDemoDatafeedStatus(arguments[0]);
                    }
                    super.resolveSymbol(
                        arguments[0],
                        arguments[1],
                        arguments[2],
                        arguments[3]
                    );
                }
            }
            const datafeed = new CustomDatafeed({
                // Optional configuration
            });

            const isDark =
                window.matchMedia &&
                window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = getParameterByName('theme') || (isDark ? 'dark' : 'light');
            const cssBlob = new Blob([customCSS], {
                type: "text/css",
            });
            const cssBlobUrl = URL.createObjectURL(cssBlob);

            // åˆ›å»ºTradingViewå°éƒ¨ä»¶å¹¶å°†å…¶èµ‹å€¼ç»™window.widgetï¼Œä½¿å…¶å…¨å±€å¯ç”¨
            window.widget = new TradingView.widget({
                container: 'chartContainer',
                locale: 'en',
                // Use the correct library path
                library_path: 'charting_library/',
                datafeed: datafeed,
                symbol: 'AAPL',
                interval: '1D',
                fullscreen: true,
                debug: true,
                theme: theme,
                custom_css_url: cssBlobUrl,
                // å¯ç”¨å›¾è¡¨å­˜å‚¨åŠŸèƒ½
                charts_storage_url: '/saveload.tradingview.com',
                charts_storage_api_version: '1.1',
                snapshot_url: '/api/snapshot',
                client_id: 'tv_proxy', // å®¢æˆ·ç«¯ID (å¯ä»¥è®¾ç½®ä¸ºæ‚¨çš„ç½‘ç«™åç§°)
                user_id: 'public_user', // ç”¨æˆ·IDï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥è®¾ç½®ä¸ºç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦
                disabled_features: [
                    'use_localstorage_for_settings',
                    'open_account_manager',
                    'dom_widget',
                ],
                enabled_features: [
                    'study_templates',
                    'drawing_templates',
                    // 'chart_template_storage',    // doesn't support this
                    'pre_post_market_sessions',
                    'show_symbol_logos',
                    'show_exchange_logos',
                    'seconds_resolution',
                    // 'custom_resolutions', // datafeed doesn't support this
                    'secondary_series_extend_time_scale',
                    // 'determine_first_data_request_size_using_visible_range',
                    'show_percent_option_for_right_margin',
                    'display_data_mode',
                    'items_favoriting',
                    'disable_resolution_rebuild',
                    'pre_post_market_price_line',
                    "charting_library_export_chart_data"
                ],
                export_data: true,
            });

            window.widget.onChartReady(function () {
                window.widget.headerReady().then(() => {
                    var button = window.widget.createButton();
                    button.setAttribute('title', 'Replay');
                    button.innerHTML = 'âª Replay';
                    button.addEventListener('click', function () {
                        // æ˜¾ç¤º/éšè—replay-menu
                        if (typeof window.toggleReplayMenu === 'function') {
                            window.toggleReplayMenu();
                        }
                    });

                    const themeToggleEl = window.widget.createButton({
                        useTradingViewStyle: false,
                        align: 'right',
                    });
                    themeToggleEl.dataset.internalAllowKeyboardNavigation = 'true';
                    themeToggleEl.id = 'theme-toggle';
                    themeToggleEl.innerHTML = `<label for="theme-switch" id="theme-switch-label">Dark Mode</label>
                        <div class="switcher">
                            <input type="checkbox" id="theme-switch" tabindex="-1">
                            <span class="thumb-wrapper">
                                <span class="track"></span>
                                <span class="thumb"></span>
                            </span>
                        </div>`;
                    themeToggleEl.title = 'Toggle theme';
                    const checkboxEl = themeToggleEl.querySelector('#theme-switch');
                    checkboxEl.checked = theme === 'dark';
                    checkboxEl.addEventListener('change', function () {
                        const themeToSet = this.checked ? 'dark' : 'light'
                        window.widget.changeTheme(themeToSet, { disableUndo: true });
                    });
                });

                // ç›‘å¬å›¾è¡¨å‘¨æœŸå˜åŒ–
                const chart = window.widget.chart();
                
                // ç›‘å¬å‘¨æœŸå˜åŒ–
                chart.onIntervalChanged().subscribe(null, function(interval) {
                    console.log('å›¾è¡¨å‘¨æœŸå·²å˜æ›´ä¸º:', interval);
                    
                    // å¦‚æœæœ‰åŸå§‹å‘¨æœŸä¸”ä¸å½“å‰ä¸åŒï¼Œæ˜¾ç¤ºæ¢å¤æŒ‰é’®
                    const restoreButton = document.getElementById('restore-interval');
                    if (tradingState.originalInterval && interval !== tradingState.originalInterval) {
                        if (restoreButton) {
                            restoreButton.style.display = 'inline-block';
                        }
                    } else {
                        if (restoreButton) {
                            restoreButton.style.display = 'none';
                        }
                    }
                });
                
                // ç›‘å¬äº¤æ˜“å¯¹å˜åŒ–
                chart.onSymbolChanged().subscribe(null, async function(symbolInfo) {
                    console.log('äº¤æ˜“å¯¹å·²å˜æ›´ä¸º:', symbolInfo.name);
                    
                    // å¦‚æœåœ¨å›æ”¾ä¸­ä¸”æœ‰å›æ”¾ä¼šè¯ï¼Œåˆ™è§†ä¸ºæ–°çš„å›æ”¾ä¼šè¯
                    if (menu.style.display !== 'none') {
                        // ç»“æŸå½“å‰å›æ”¾ä¼šè¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                        await finishCurrentReplaySession();
                        
                        // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨æ ‡è®°
                        clearAllDrawings();

                        // æ¸…ç©ºäº¤æ˜“çŠ¶æ€
                        if (tradingState.inPosition) {
                            tradingState.inPosition = false;
                            tradingState.positionType = null;
                            tradingState.entryPrice = 0;
                            clearPositionInfo();
                            toggleTradingButtons(false);
                        }
                        
                        // å¦‚æœæ˜¯éšæœºæ¨¡å¼ï¼Œé‡æ–°è¯·æ±‚éšæœºå›æ”¾èµ·å§‹ç‚¹
                        if (replayModeText && replayModeText.textContent.includes('éšæœºKçº¿')) {
                            requestRandomReplayPoint();
                        }
                    }
                });
            });
        }

        window.addEventListener('DOMContentLoaded', initOnReady, false);
    </script>
</head>

<body style="margin: 0px; touch-action: manipulation; -webkit-text-size-adjust: 100%; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;">

    <div id="chartContainer" style="height: 100vh; width: 100vw;"></div>
    <!-- Replay æµ®åŠ¨èœå• -->
    <div id="replay-menu">
        <div id="replay-mode-container" class="custom-dropdown" style="margin-right:6px;">
            <div id="replay-mode-selected" class="dropdown-selected" title="é€‰æ‹©æ¨¡å¼">
                <span id="replay-mode-text">ğŸ² éšæœºKçº¿</span>
                <span class="dropdown-arrow">â–¼</span>
            </div>
            <div id="replay-mode-options" class="dropdown-options">
                <div class="dropdown-option" data-value="random">ğŸ² éšæœºKçº¿</div>
                <div class="dropdown-option" data-value="custom">â° é€‰æ‹©æ—¶é—´</div>
            </div>
        </div>
        <input type="datetime-local" id="replay-datetime" style="display:none;margin-right:6px;">
        <button id="replay-play" title="æ’­æ”¾">â–¶ï¸</button>
        <button id="replay-pause" title="æš‚åœ" style="display:none;">â¸ï¸</button>
        <button id="replay-next" title="å‰è¿›">â­ï¸</button>
        <select id="replay-speed" title="å€é€Ÿé€‰æ‹©" style="margin:0 6px;">
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="5">5x</option>
        </select>
        <div class="replay-divider"></div>
        <!-- å›æ”¾çŠ¶æ€ä¿¡æ¯ -->
        <div id="replay-status" class="replay-status">
            <div id="remaining-bars" class="status-item" title="å‰©ä½™Kçº¿æ•°">
                <span class="status-label">å‰©ä½™:</span>
                <span id="remaining-bars-value" class="status-value">--</span>
            </div>
            <div id="current-pnl" class="status-item" title="å½“å‰ç›ˆäº" style="display:none;">
                <span class="status-label">ç›ˆäº:</span>
                <span id="current-pnl-value" class="status-value">--</span>
            </div>
            <div id="account-balance" class="status-item" title="è´¦æˆ·æ€»è§ˆ">
                <span class="status-label">ä½™é¢:</span>
                <span id="account-balance-value" class="status-value">10000.00</span>
            </div>
        </div>
        <div class="replay-divider"></div>
        <!-- äº¤æ˜“æ§åˆ¶åŒº -->
        <div id="trading-controls">
            <!-- æŠ•å…¥é‡‘é¢ -->
            <div class="trade-input-group">
                <label for="invest-amount">æŠ•å…¥</label>
                <input type="number" id="invest-amount" value="100">
                <span>USDT</span>
            </div>

            <!-- æ æ†é€‰æ‹© -->
            <div class="trade-input-group">
                <label for="leverage-selector">æ æ†</label>
                <select id="leverage-selector">
                    <option value="1">1x</option>
                    <option value="5">5x</option>
                    <option value="10">10x</option>
                    <option value="20">20x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                </select>
            </div>

            <button id="buy-button" class="trade-button buy">ä¹°å…¥</button>
            <button id="sell-button" class="trade-button sell">å–å‡º</button>
            <button id="close-position" class="trade-button close" disabled>å¹³ä»“</button>
            <div id="position-info" class="position-info">
                <span id="position-type"></span>
                <span id="position-price"></span>
            </div>
        </div>
        <div class="replay-divider"></div>
        <button id="stats-button" class="trade-button stats" title="äº¤æ˜“ç»Ÿè®¡">æ€»è§ˆ</button>
        <button id="history-button" class="trade-button history" title="å†å²è®°å½•">å†å²</button>
        <button id="restore-interval" class="trade-button restore" title="æ¢å¤åŸå§‹å‘¨æœŸ" style="display:none;">æ¢å¤å‘¨æœŸ</button>
        <button id="replay-close" title="å…³é—­">âŒ</button>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯å¼¹çª— -->
    <div id="stats-modal" class="stats-modal">
        <div class="stats-modal-header">
            <div class="stats-modal-title">äº¤æ˜“ç»Ÿè®¡</div>
            <button id="stats-modal-close" class="stats-modal-close">&times;</button>
        </div>
        <div class="stats-content">
            <div class="stats-item">
                <span class="stats-label">æ€»äº¤æ˜“æ•°:</span>
                <span id="total-trades" class="stats-value">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">ç›ˆåˆ©äº¤æ˜“:</span>
                <span id="profitable-trades" class="stats-value">0</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">æˆåŠŸç‡:</span>
                <span id="win-rate" class="stats-value">0%</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">æ€»ç›ˆäº:</span>
                <span id="total-pnl" class="stats-value">0.00</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">ç›ˆåˆ©ç‡:</span>
                <span id="profit-rate" class="stats-value">0.00%</span>
            </div>
        </div>
    </div>

    <!-- å†å²å›æ”¾è®°å½•å¼¹çª— -->
    <div id="history-modal" class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">å›æ”¾å†å²è®°å½•</div>
                <button id="history-modal-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="history-list" class="history-list">
                    <!-- å†å²è®°å½•åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                </div>
                <div id="history-loading" class="history-loading">
                    <div class="loading-spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
                <div id="history-empty" class="history-empty" style="display:none;">
                    æš‚æ— å†å²å›æ”¾è®°å½•
                </div>
            </div>
        </div>
    </div>

    <style>
        #replay-menu {
            position: fixed;
            left: 50%;
            bottom: 40px;
            top: auto;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(40, 44, 52, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            padding: 8px 12px;
            user-select: none;
            cursor: move;
            border: 1px solid #222b;
            transition: left 0.2s, top 0.2s, bottom 0.2s, transform 0.2s;
            max-width: calc(100vw - 20px);
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #replay-menu {
                flex-wrap: wrap;
                gap: 4px;
                padding: 6px 8px;
                bottom: 10px;
                left: 10px;
                right: 10px;
                transform: none;
                width: calc(100vw - 20px);
                max-width: none;
                box-sizing: border-box;
            }
        }
        
        /* iPhone 15ç³»åˆ—ç‰¹å®šä¼˜åŒ– */
        @media (max-width: 430px) and (max-height: 932px) {
            #replay-menu {
                bottom: 5px;
                left: 5px;
                right: 5px;
                width: calc(100vw - 10px);
                padding: 4px 6px;
                gap: 3px;
                font-size: 13px;
            }
            
            .trade-button {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 55px;
            }
            
            .trade-input-group {
                padding: 4px 6px;
                min-width: 80px;
            }
            
            .trade-input-group input,
            .trade-input-group select {
                width: 50px;
                padding: 4px;
                font-size: 12px;
            }
            
            .custom-dropdown {
                min-width: 110px;
            }
            
            .dropdown-selected {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .status-item {
                padding: 3px 5px;
                font-size: 10px;
                min-width: 65px;
            }
        }
        #debug-menu button {
            background: #23272e;
            border: none;
            color: #fff;
            font-size: 18px;
            border-radius: 4px;
            padding: 6px 10px;
            margin: 0;
            transition: background 0.2s;
            outline: none;
        }
        #debug-menu button:hover {
            background: #3a3f4b;
        }
        /* Custom dropdown styles */
        .custom-dropdown {
            position: relative;
            min-width: 120px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .custom-dropdown {
                min-width: 140px;
                flex-shrink: 0;
            }
        }
        .dropdown-selected {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #23272e;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #3a3f4b;
        }
        
        @media (max-width: 768px) {
            .dropdown-selected {
                padding: 8px 12px;
                font-size: 14px;
                touch-action: manipulation;
            }
        }
        .dropdown-arrow {
            font-size: 10px;
            margin-left: 8px;
        }
        .dropdown-options {
            position: absolute;
            width: 100%;
            background: #23272e;
            border-radius: 4px;
            border: 1px solid #3a3f4b;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            z-index: 10000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .dropdown-option {
            padding: 8px 10px;
            transition: background 0.2s;
        }
        .dropdown-option:hover, .dropdown-option.selected {
            background: #3a3f4b;
        }
        /* Trading controls styles */
        #trading-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            #trading-controls {
                flex-wrap: wrap;
                gap: 4px;
                justify-content: center;
                width: 100%;
            }
        }
        .trade-button {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 60px;
        }
        
        @media (max-width: 768px) {
            .trade-button {
                padding: 8px 12px;
                font-size: 14px;
                min-width: 70px;
                touch-action: manipulation;
            }
        }
        .trade-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .trade-button.buy {
            background-color: #26a69a; /* ç»¿è‰² - ä¹°å…¥ */
        }
        .trade-button.buy:hover:not(:disabled) {
            background-color: #2bbbad;
        }
        .trade-button.sell {
            background-color: #ef5350; /* çº¢è‰² - å–å‡º */
        }
        .trade-button.sell:hover:not(:disabled) {
            background-color: #f76d6a;
        }
        .trade-button.close {
            background-color: #7b8089; /* ç°è‰² - å¹³ä»“ */
        }
        .trade-button.close:hover:not(:disabled) {
            background-color: #9ea5b0;
        }
        .trade-button.stats {
            background-color: #2962FF; /* è“è‰² - ç»Ÿè®¡ */
        }
        .trade-button.stats:hover:not(:disabled) {
            background-color: #1E53E5;
        }
        .trade-button.restore {
            background-color: #7b8089; /* ç°è‰² - æ¢å¤å‘¨æœŸ */
        }
        .trade-button.restore:hover:not(:disabled) {
            background-color: #9ea5b0;
        }
        .position-info {
            display: flex;
            flex-direction: column;
            min-width: 60px;
            padding: 4px 8px;
            background: rgba(35, 39, 46, 0.8);
            border-radius: 4px;
            font-size: 12px;
            color: white;
            border: 1px solid #3a3f4b;
        }
        .trade-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #23272e;
            padding: 4px 8px;
            border-radius: 4px;
            color: #fff;
            min-width: 90px;
        }
        
        @media (max-width: 768px) {
            .trade-input-group {
                padding: 6px 10px;
                min-width: 100px;
                flex-shrink: 0;
            }
        }
        .trade-input-group label {
            font-size: 12px;
            color: #9ea5b0;
        }
        .trade-input-group input,
        .trade-input-group select {
            background: #1e2228;
            border: 1px solid #3a3f4b;
            color: #fff;
            border-radius: 4px;
            padding: 4px;
            width: 60px;
            text-align: right;
        }
        
        @media (max-width: 768px) {
            .trade-input-group input,
            .trade-input-group select {
                padding: 6px;
                width: 70px;
                font-size: 14px;
                touch-action: manipulation;
            }
        }
        .trade-input-group span {
            font-size: 12px;
            color: #9ea5b0;
        }
        .replay-divider {
            width: 1px;
            height: 24px;
            background-color: #3a3f4b;
            margin: 0 4px;
        }
        /* å›æ”¾çŠ¶æ€ä¿¡æ¯æ ·å¼ */
        .replay-status {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 80px;
        }
        
        @media (max-width: 768px) {
            .replay-status {
                flex-direction: row;
                gap: 6px;
                min-width: 100%;
                justify-content: space-around;
                flex-wrap: wrap;
            }
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 6px;
            background: rgba(35, 39, 46, 0.8);
            border-radius: 3px;
            font-size: 11px;
            color: white;
            border: 1px solid #3a3f4b;
        }
        
        @media (max-width: 768px) {
            .status-item {
                padding: 4px 8px;
                font-size: 12px;
                min-width: 80px;
                flex: 1;
                max-width: calc(50% - 3px);
            }
        }
        .status-label {
            color: #9ea5b0;
            margin-right: 4px;
        }
        .status-value {
            font-weight: bold;
            font-size: 11px;
        }
        .status-value.positive {
            color: #26a69a;
        }
        .status-value.negative {
            color: #ef5350;
        }
        .status-value.warning {
            color: #ff9800;
        }
        /* ç»Ÿè®¡ä¿¡æ¯å¼¹çª—æ ·å¼ */
        .stats-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 44, 52, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            padding: 20px;
            z-index: 10000;
            color: white;
            min-width: 300px;
            border: 1px solid #3a3f4b;
        }
        .stats-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #3a3f4b;
            padding-bottom: 10px;
        }
        .stats-modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        .stats-modal-close {
            background: none;
            border: none;
            color: #9ea5b0;
            font-size: 20px;
            cursor: pointer;
        }
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #3a3f4b30;
        }
        .stats-label {
            color: #9ea5b0;
        }
        .stats-value {
            font-weight: bold;
        }
        .stats-value.positive {
            color: #26a69a;
        }
        .stats-value.negative {
            color: #ef5350;
        }
        
        /* å†å²å›æ”¾è®°å½•æ¨¡æ€æ¡†æ ·å¼ */
        .modal-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            overflow: hidden;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 44, 52, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            color: white;
            border: 1px solid #3a3f4b;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #3a3f4b;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #9ea5b0;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 15px 20px;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .history-item {
            background: rgba(50, 54, 62, 0.6);
            border-radius: 6px;
            padding: 12px;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background: rgba(60, 64, 72, 0.8);
            border-left-color: #2962FF;
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .history-item-symbol {
            font-weight: bold;
            font-size: 16px;
        }
        
        .history-item-date {
            color: #9ea5b0;
            font-size: 12px;
        }
        
        .history-item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .history-detail {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #3a3f4b20;
        }
        
        .history-detail-label {
            color: #9ea5b0;
            font-size: 13px;
        }
        
        .history-detail-value {
            font-weight: bold;
            font-size: 13px;
        }
        
        .history-item-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
            gap: 8px;
        }
        
        .history-action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-action-replay {
            background-color: #2962FF;
            color: white;
        }
        
        .history-action-replay:hover {
            background-color: #1E53E5;
        }
        
        .history-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
            color: #9ea5b0;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(158, 165, 176, 0.3);
            border-radius: 50%;
            border-top-color: #9ea5b0;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .history-empty {
            text-align: center;
            padding: 30px 0;
            color: #9ea5b0;
            font-style: italic;
        }
        
        .history-detail-value.positive {
            color: #26a69a;
        }
        
        .history-detail-value.negative {
            color: #ef5350;
        }
        
        .trade-button.history {
            background-color: #7B1FA2; /* ç´«è‰² - å†å² */
        }
        
        .trade-button.history:hover:not(:disabled) {
            background-color: #9C27B0;
        }
        
        /* ç§»åŠ¨ç«¯å¼¹çª—ä¼˜åŒ– */
        @media (max-width: 768px) {
            .stats-modal,
            .modal-container {
                z-index: 10001;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                max-height: 90vh;
                margin: 5vh auto;
            }
            
            .stats-modal {
                width: 90%;
                max-width: 90%;
                padding: 15px;
            }
            
            /* ç¡®ä¿å¼¹çª—å†…å®¹å¯æ»šåŠ¨ */
            .modal-body {
                max-height: calc(90vh - 80px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
    <script>
        // æ‹–åŠ¨æµ®åŠ¨èœå•
        (function() {
            var menu = document.getElementById('replay-menu');
            // åˆå§‹å±…ä¸­åº•éƒ¨
            menu.style.display = 'none'; // åˆå§‹éšè—
            var isDragging = false;
            var offsetX = 0, offsetY = 0;
            var hasMoved = false;
            // åªå…è®¸é€šè¿‡èœå•ç©ºç™½åŒºåŸŸæ‹–åŠ¨ - æ”¯æŒè§¦æ‘¸
            function startDrag(e) {
                if (e.target !== menu) return;
                isDragging = true;
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                offsetX = clientX - menu.offsetLeft;
                offsetY = clientY - menu.offsetTop;
                menu.style.transition = 'none';
                e.preventDefault();
            }
            
            menu.addEventListener('mousedown', startDrag);
            menu.addEventListener('touchstart', startDrag, { passive: false });
            function moveDrag(e) {
                if (isDragging) {
                    hasMoved = true;
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    menu.style.left = (clientX - offsetX) + 'px';
                    menu.style.top = (clientY - offsetY) + 'px';
                    menu.style.bottom = 'auto';
                    menu.style.transform = '';
                    e.preventDefault();
                }
            }
            
            function endDrag() {
                isDragging = false;
                menu.style.transition = '';
            }
            
            document.addEventListener('mousemove', moveDrag);
            document.addEventListener('touchmove', moveDrag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            // å…³é—­æŒ‰é’®
            var replayCloseBtn = document.getElementById('replay-close');
            if (replayCloseBtn) {
                replayCloseBtn.onclick = async function() {
                    // åœ¨å…³é—­å›æ”¾èœå•æ—¶ç»“æŸå½“å‰ä¼šè¯
                    await finishCurrentReplaySession();
                    menu.style.display = 'none';
                };
            }
            // è‡ªå®šä¹‰ä¸‹æ‹‰èœå•
            var replayModeContainer = document.getElementById('replay-mode-container');
            var replayModeSelected = document.getElementById('replay-mode-selected');
            var replayModeOptions = document.getElementById('replay-mode-options');
            var replayModeText = document.getElementById('replay-mode-text');
            var replayDatetime = document.getElementById('replay-datetime');
            var replayStartBtn = document.getElementById('replay-start');
            
            if (replayModeContainer && replayModeSelected && replayModeOptions) {
                // è·å–ä¸‹æ‹‰ç®­å¤´å…ƒç´ 
                var dropdownArrow = replayModeSelected.querySelector('.dropdown-arrow');
                var modeText = replayModeSelected.querySelector('#replay-mode-text');
                
                // ç‚¹å‡»æ–‡æœ¬ç›´æ¥è§¦å‘å¯¹åº”çš„æ“ä½œ
                if (modeText) {
                    modeText.addEventListener('click', function(e) {
                        e.stopPropagation();
                        // è·å–å½“å‰é€‰ä¸­çš„å€¼
                        var currentValue = modeText.textContent.includes('éšæœºKçº¿') ? 'random' : 'custom';
                        triggerOptionAction(currentValue, modeText.textContent);
                    });
                }
                
                // ç‚¹å‡»ä¸‹æ‹‰ç®­å¤´æ˜¾ç¤º/éšè—ä¸‹æ‹‰èœå•
                if (dropdownArrow) {
                    dropdownArrow.addEventListener('click', function(e) {
                        e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                        
                        // è®¡ç®—æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´åœ¨ä¸‹æ–¹æ˜¾ç¤º
                        var rect = replayModeContainer.getBoundingClientRect();
                        var bottomSpace = window.innerHeight - rect.bottom;
                        var optionsHeight = replayModeOptions.scrollHeight || 200; // é¢„ä¼°é«˜åº¦
                        
                        // è®¾ç½®ä¸‹æ‹‰èœå•ä½ç½®
                        if (bottomSpace < optionsHeight) {
                            // åº•éƒ¨ç©ºé—´ä¸è¶³ï¼Œå‘ä¸Šæ˜¾ç¤º
                            replayModeOptions.style.bottom = '100%';
                            replayModeOptions.style.top = 'auto';
                            replayModeOptions.style.marginBottom = '5px';
                        } else {
                            // åº•éƒ¨ç©ºé—´å……è¶³ï¼Œå‘ä¸‹æ˜¾ç¤º
                            replayModeOptions.style.top = '100%';
                            replayModeOptions.style.bottom = 'auto';
                            replayModeOptions.style.marginTop = '5px';
                        }
                        
                        // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                        if (replayModeOptions.style.display === 'block') {
                            replayModeOptions.style.display = 'none';
                        } else {
                            replayModeOptions.style.display = 'block';
                        }
                    });
                }
                // å¤„ç†é€‰é¡¹ç‚¹å‡»é€»è¾‘çš„å‡½æ•°
                function triggerOptionAction(value, text) {
                    // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                    if (replayModeText) {
                        replayModeText.textContent = text;
                    }
                    
                    // å…³é—­ä¸‹æ‹‰èœå•
                    replayModeOptions.style.display = 'none';
                    
                    // å¤„ç†æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨çš„æ˜¾ç¤º/éšè—
                    if (value === 'custom' && replayDatetime) {
                        replayDatetime.style.display = 'inline-block';
                        // å¦‚æœå·²ç»æœ‰å€¼ï¼Œæ›´æ–°å›¾è¡¨èŒƒå›´
                        if (replayDatetime.value) {
                            updateChartVisibleRange(replayDatetime.value);
                        }
                    } else if (value === 'random' && replayDatetime) {
                        replayDatetime.style.display = 'none';
                        // è¯·æ±‚éšæœºå›æ”¾èµ·å§‹ç‚¹
                        requestRandomReplayPoint();
                    } else if (replayDatetime) {
                        replayDatetime.style.display = 'none';
                    }
                    
                    // è§¦å‘æ¨¡å¼å˜æ›´äº‹ä»¶
                    var event = new CustomEvent('replay-mode-change', {
                        detail: { value: value, text: text }
                    });
                    document.dispatchEvent(event);
                }
                
                // è¯·æ±‚éšæœºå›æ”¾èµ·å§‹ç‚¹
                async function requestRandomReplayPoint() {
                    // ç»“æŸå½“å‰å›æ”¾ä¼šè¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    await finishCurrentReplaySession();
                    
                    // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨æ ‡è®°
                    clearAllDrawings();

                    // è·å–å½“å‰symbolå’Œinterval
                    let symbol = '';
                    let interval = '';
                    
                    try {
                        if (window.widget) {
                            const symbol_interval = window.widget.symbolInterval();
                            symbol = symbol_interval.symbol;
                            interval = symbol_interval.interval;
                            
                            // ä¿å­˜åŸå§‹å‘¨æœŸï¼Œç”¨äºåç»­æ¢å¤
                            tradingState.originalInterval = interval;
                        }
                    } catch (e) {
                        console.error('è·å–å½“å‰å›¾è¡¨ä¿¡æ¯å¤±è´¥:', e);
                    }
                    
                    // æ„å»ºæŸ¥è¯¢å‚æ•°
                    const queryParams = new URLSearchParams();
                    // if (symbol) queryParams.append('symbol', symbol);
                    if (interval) queryParams.append('interval', interval);
                    
                    // è¯·æ±‚éšæœºå›æ”¾èµ·å§‹ç‚¹
                    fetch('/api/replay/random?' + queryParams.toString())
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'ok') {
                                console.log('è·å–éšæœºå›æ”¾èµ·å§‹ç‚¹æˆåŠŸ:', data.data);
                                
                                // ä¿å­˜å›æ”¾ä¿¡æ¯
                                tradingState.replayStartTime = data.data.start_time;
                                tradingState.barsCount = data.data.bars_count;
                                
                                // å¦‚æœè¿”å›äº†ä¸åŒçš„symbolï¼Œéœ€è¦åˆ‡æ¢
                                if (data.data.symbol && data.data.symbol !== symbol) {
                                    // åˆ‡æ¢äº¤æ˜“å¯¹ (ä½¿ç”¨ chart.setSymbol)
                                    console.log(`[è¯Šæ–­æ—¥å¿—] å‡†å¤‡åˆ‡æ¢äº¤æ˜“å¯¹åˆ°: ${data.data.symbol}`);
                                    const chart = window.widget.chart();
                                    chart.setSymbol(data.data.symbol, function() {
                                        console.log(`[è¯Šæ–­æ—¥å¿—] äº¤æ˜“å¯¹åˆ‡æ¢æˆåŠŸ: ${data.data.symbol}ï¼Œç°åœ¨è®¾ç½®å›æ”¾èŒƒå›´`);
                                        // è®¾ç½®å›¾è¡¨èŒƒå›´
                                        setChartRangeFromTimestamp(data.data.start_time, data.data.bars_count);
                                    });
                                } else {
                                    // ç›´æ¥è®¾ç½®å›¾è¡¨èŒƒå›´
                                    setChartRangeFromTimestamp(data.data.start_time, data.data.bars_count);
                                }
                                
                                // å›æ”¾ä¼šè¯IDå·²åœ¨finishCurrentReplaySessionä¸­é‡ç½®
                                
                                // æ¸…ç©ºäº¤æ˜“çŠ¶æ€
                                if (tradingState.inPosition) {
                                    tradingState.inPosition = false;
                                    tradingState.positionType = null;
                                    tradingState.entryPrice = 0;
                                    clearPositionInfo();
                                    toggleTradingButtons(false);
                                }
                            } else {
                                console.error('è·å–éšæœºå›æ”¾èµ·å§‹ç‚¹å¤±è´¥:', data.message);
                                alert('è·å–éšæœºå›æ”¾èµ·å§‹ç‚¹å¤±è´¥: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('è¯·æ±‚éšæœºå›æ”¾èµ·å§‹ç‚¹æ—¶å‡ºé”™:', error);
                            alert('è¯·æ±‚éšæœºå›æ”¾èµ·å§‹ç‚¹æ—¶å‡ºé”™');
                        });
                }
                
                // æ ¹æ®æ—¶é—´æˆ³è®¾ç½®å›¾è¡¨èŒƒå›´
                function setChartRangeFromTimestamp(timestamp, barsCount) {
                    if (!window.widget) return Promise.resolve(null);
                    
                    try {
                        const chart = window.widget.chart();
                        const interval = chart.resolution();
                        
                        // è®¡ç®—æ¯ä¸ªbarçš„ç§’æ•°
                        const secondsPerBar = calculateSecondsPerBar(interval);
                        
                        // è®¡ç®—å›æ”¾ç»“æŸæ—¶é—´ï¼ˆä»å¼€å§‹æ—¶é—´ç®—èµ·ï¼Œæœ€å¤šæ˜¾ç¤ºbarsCountæ ¹Kçº¿ï¼‰
                        const replayEndTime = timestamp + (barsCount * secondsPerBar);
                        
                        // è®¾ç½®åˆå§‹å¯è§èŒƒå›´ - æ˜¾ç¤º100æ ¹Kçº¿ï¼Œå…¶ä¸­99æ ¹åœ¨å½“å‰æ—¶é—´ä¹‹å‰ï¼Œ1æ ¹åœ¨å½“å‰æ—¶é—´
                        const rangeStartTimestamp = timestamp - (99 * secondsPerBar);
                        const rangeEndTimestamp = timestamp + (1 * secondsPerBar);
                        
                        console.log('è®¾ç½®å›æ”¾èŒƒå›´ - æ—¶é—´å‘¨æœŸ:', interval,
                                  'å¼€å§‹æ—¶é—´:', new Date(timestamp * 1000).toLocaleString(),
                                  'ç»“æŸæ—¶é—´:', new Date(replayEndTime * 1000).toLocaleString(),
                                  'Kçº¿æ•°é‡:', barsCount);
                        
                        // ä¿å­˜å›æ”¾æ—¶é—´ä¿¡æ¯
                        tradingState.replayStartTime = timestamp;
                        tradingState.replayEndTime = replayEndTime;
                        tradingState.barsCount = barsCount;
                        tradingState.currentBarTime = timestamp;
                        
                        // ä¿å­˜æœŸæœ›çš„èŒƒå›´
                        tradingState.expectedVisibleRange = { from: rangeStartTimestamp, to: rangeEndTimestamp };

                        // è®¾ç½®å¯è§èŒƒå›´
                        return chart.setVisibleRange({
                            from: rangeStartTimestamp,
                            to: rangeEndTimestamp
                        }).then(function() {
                            console.log('å›¾è¡¨èŒƒå›´å·²è®¾ç½®');
                            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                            updateReplayStatus();
                            // è®°å½•å¸‚åœºèµ·å§‹ä»·æ ¼
                            recordMarketPrice('start');
                            return { start: rangeStartTimestamp, end: rangeEndTimestamp };
                        }).catch(function(error) {
                            console.error('è®¾ç½®å›¾è¡¨èŒƒå›´å¤±è´¥:', error);
                            return null;
                        });
                    } catch(e) {
                        console.error('è®¾ç½®å›¾è¡¨èŒƒå›´æ—¶å‡ºé”™:', e);
                        return Promise.resolve(null);
                    }
                }
                
                // ç‚¹å‡»é€‰é¡¹
                var options = replayModeOptions.querySelectorAll('.dropdown-option');
                options.forEach(function(option) {
                    option.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var value = this.getAttribute('data-value');
                        var text = this.textContent;
                        
                        triggerOptionAction(value, text);
                    });
                });
                
                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', function() {
                    if (replayModeOptions) {
                        replayModeOptions.style.display = 'none';
                    }
                });
            }
            
            // äº‹ä»¶é¢„ç•™
            var replayPlayBtn = document.getElementById('replay-play');

            var replayNextBtn = document.getElementById('replay-next');
            if (replayNextBtn) {
                replayNextBtn.onclick = function() {
                    // è·å–å½“å‰é€‰æ‹©çš„å€é€Ÿ
                    var speed = parseInt(replaySpeedSel ? replaySpeedSel.value : 1);
                    if (isNaN(speed) || speed < 1) speed = 1;
                    
                    // æŒ‰ç…§é€‰æ‹©çš„å€é€Ÿå‰è¿›
                    advanceChartRange(speed).then(function(result) {
                        if (!result) {
                            console.error('å‰è¿›å¤±è´¥ï¼Œæ— æ³•ç§»åŠ¨å›¾è¡¨èŒƒå›´');
                        }
                    });
                };
            }
            // è§£é™¤ä¹‹å‰çš„ç»‘å®šçš„äº‹ä»¶å¤„ç†ç¨‹åº
            if (replaySpeedSel) {
                replaySpeedSel.onchange = function(e) {
                    // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¼€å§‹ä»¥æ–°çš„é€Ÿåº¦æ’­æ”¾
                    if (isPlaying) {
                        stopPlayback();
                        startPlayback();
                    }
                };
            }
            
            // æ’­æ”¾ç›¸å…³å˜é‡
            var playbackInterval = null;
            var isPlaying = false;
            var replayPlayBtn = document.getElementById('replay-play');
            var replayPauseBtn = document.getElementById('replay-pause');
            var replaySpeedSel = document.getElementById('replay-speed');
            
            // æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
            if (replayDatetime) {
                replayDatetime.addEventListener('change', async function(e) {
                    if (this.value) {
                        // ç»“æŸå½“å‰å›æ”¾ä¼šè¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                        await finishCurrentReplaySession();
                        
                        // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨æ ‡è®°
                        clearAllDrawings();

                        // å°†æ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´æˆ³
                        var timestamp = new Date(this.value).getTime() / 1000;
                        
                        // ä¿å­˜å›æ”¾å¼€å§‹æ—¶é—´
                        tradingState.replayStartTime = timestamp;
                        
                        // ä½¿ç”¨æ–°çš„å›æ”¾èŒƒå›´è®¡ç®—æ–¹æ³•
                        setChartRangeFromTimestamp(timestamp, tradingState.barsCount);
                        
                        // ä¿å­˜å½“å‰å‘¨æœŸä½œä¸ºåŸå§‹å‘¨æœŸ
                        try {
                            if (window.widget) {
                                const symbol_interval = window.widget.symbolInterval();
                                tradingState.originalInterval = symbol_interval.interval;
                            }
                        } catch (e) {
                            console.error('è·å–å½“å‰å›¾è¡¨ä¿¡æ¯å¤±è´¥:', e);
                        }
                        
                        // å›æ”¾ä¼šè¯IDå·²åœ¨finishCurrentReplaySessionä¸­é‡ç½®
                        
                        // æ¸…ç©ºäº¤æ˜“çŠ¶æ€
                        if (tradingState.inPosition) {
                            tradingState.inPosition = false;
                            tradingState.positionType = null;
                            tradingState.entryPrice = 0;
                            clearPositionInfo();
                            toggleTradingButtons(false);
                        }
                    }
                });
            }
            
            // æ’­æ”¾æŒ‰é’®äº‹ä»¶
            if (replayPlayBtn && replayPauseBtn) {
                replayPlayBtn.addEventListener('click', function() {
                    var currentMode = replayModeText ? replayModeText.textContent : '';
                    
                    //if (currentMode.includes('é€‰æ‹©æ—¶é—´') && replayDatetime && replayDatetime.value) {
                        // å¦‚æœæ˜¯æ—¶é—´æ¨¡å¼ä¸”å·²é€‰æ‹©æ—¶é—´ï¼Œå…ˆå®šä½åˆ°é€‰æ‹©æ—¶é—´
                    //    updateChartVisibleRange(replayDatetime.value);
                    //}
                    
                    // å¼€å§‹æ’­æ”¾
                    startPlayback();
                });
                
                // æš‚åœæŒ‰é’®äº‹ä»¶
                replayPauseBtn.addEventListener('click', function() {
                    stopPlayback();
                });
            }
            
            // æ§åˆ¶å›¾è¡¨æ˜¾ç¤ºèŒƒå›´çš„å‡½æ•°
            function updateChartVisibleRange(datetimeStr) {
                if (!window.widget) return;
                
                try {
                    // å°†æ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´æˆ³
                    var timestamp = new Date(datetimeStr).getTime() / 1000;
                    var chart = window.widget.chart();
                    
                    // è·å–å½“å‰æ—¶é—´å‘¨æœŸ
                    var interval = window.widget.chart().resolution();
                    
                    // æ ¹æ®æ—¶é—´å‘¨æœŸè®¡ç®—å•ä¸ªbarçš„ç§’æ•°
                    var secondsPerBar = calculateSecondsPerBar(interval);
                    
                    // è®¡ç®—å›æ”¾ç»“æŸæ—¶é—´ï¼ˆä»å¼€å§‹æ—¶é—´ç®—èµ·ï¼Œæœ€å¤šæ˜¾ç¤ºbarsCountæ ¹Kçº¿ï¼‰
                    const replayEndTime = timestamp + (tradingState.barsCount * secondsPerBar);
                    
                    // è®¡ç®—èŒƒå›´ - æ˜¾ç¤º100æ ¹kçº¿ï¼Œå…¶ä¸­99æ ¹åœ¨å½“å‰æ—¶é—´ä¹‹å‰ï¼Œ1æ ¹åœ¨å½“å‰æ—¶é—´
                    var rangeStartTimestamp = timestamp - (99 * secondsPerBar);
                    var rangeEndTimestamp = timestamp + (1 * secondsPerBar);
                    
                    console.log('æ—¶é—´å‘¨æœŸ: ' + interval + ', æ¯ä¸ªbarç§’æ•°: ' + secondsPerBar);
                    console.log('è®¾ç½®èŒƒå›´ä» ' + new Date(rangeStartTimestamp * 1000).toLocaleString() +
                               ' åˆ° ' + new Date(rangeEndTimestamp * 1000).toLocaleString());
                    
                    // ä¿å­˜å›æ”¾æ—¶é—´ä¿¡æ¯
                    tradingState.replayStartTime = timestamp;
                    tradingState.replayEndTime = replayEndTime;
                    tradingState.currentBarTime = timestamp;

                    // ä¿å­˜æœŸæœ›çš„èŒƒå›´
                    tradingState.expectedVisibleRange = { from: rangeStartTimestamp, to: rangeEndTimestamp };

                    // è®¾ç½®å¯è§èŒƒå›´
                    return chart.setVisibleRange({
                        from: rangeStartTimestamp,
                        to: rangeEndTimestamp
                    }).then(function() {
                        console.log('å›¾è¡¨èŒƒå›´å·²è®¾ç½®åˆ°é€‰æ‹©çš„æ—¶é—´ï¼Œæ˜¾ç¤º100æ ¹Kçº¿');
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        updateReplayStatus();
                        // è®°å½•å¸‚åœºèµ·å§‹ä»·æ ¼
                        recordMarketPrice('start');
                        return { start: rangeStartTimestamp, end: rangeEndTimestamp };
                    }).catch(function(error) {
                        console.error('è®¾ç½®å›¾è¡¨èŒƒå›´å¤±è´¥:', error);
                        return null;
                    });
                } catch(e) {
                    console.error('æ›´æ–°å›¾è¡¨èŒƒå›´æ—¶å‡ºé”™:', e);
                    return Promise.resolve(null);
                }
            }
            
            // ç§»åŠ¨å›¾è¡¨èŒƒå›´çš„å‡½æ•°ï¼ˆæ’­æ”¾æ—¶ä½¿ç”¨ï¼‰
            function advanceChartRange(barsToAdvance) {
                if (!window.widget) return Promise.resolve(null);

                try {
                    var chart = window.widget.chart();
                    var interval = chart.resolution();
                    var secondsPerBar = calculateSecondsPerBar(interval);

                    // ä½¿ç”¨æˆ‘ä»¬è‡ªå·±ç»´æŠ¤çš„æœŸæœ›èŒƒå›´ï¼Œè€Œä¸æ˜¯ä»å›¾è¡¨è·å–
                    var range = tradingState.expectedVisibleRange;
                    if (!range) {
                        console.error('æ— æ³•å‰è¿›ï¼ŒæœŸæœ›çš„èŒƒå›´æœªè®¾ç½®');
                        stopPlayback(); // åœæ­¢æ’­æ”¾ä»¥å…æ­»å¾ªç¯
                        return Promise.resolve(null);
                    }

                    // è®¡ç®—æ–°çš„èŒƒå›´ï¼Œå‘å‰ç§»åŠ¨æŒ‡å®šæ•°é‡çš„bar
                    var secondsToAdvance = barsToAdvance * secondsPerBar;
                    var newFrom = range.from + secondsToAdvance;
                    var newTo = range.to + secondsToAdvance;

                    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡å›æ”¾ç»“æŸæ—¶é—´
                    if (tradingState.replayEndTime && newTo > tradingState.replayEndTime) {
                        console.log('å·²è¾¾åˆ°å›æ”¾ç»“æŸæ—¶é—´ï¼Œåœæ­¢æ’­æ”¾');
                        // ç»“æŸå½“å‰å›æ”¾ä¼šè¯
                        finishCurrentReplaySession();
                        stopPlayback();
                        return Promise.resolve(null);
                    }

                    // æ›´æ–°å½“å‰Kçº¿æ—¶é—´
                    tradingState.currentBarTime = newTo;

                    console.log('ç§»åŠ¨èŒƒå›´: æœŸæœ›ä» ' + new Date(range.from * 1000).toLocaleString() +
                                ' åˆ° ' + new Date(range.to * 1000).toLocaleString());
                    console.log('æ–°èŒƒå›´ï¼šä» ' + new Date(newFrom * 1000).toLocaleString() +
                                ' åˆ° ' + new Date(newTo * 1000).toLocaleString());

                    // æ›´æ–°æˆ‘ä»¬æœŸæœ›çš„èŒƒå›´
                    tradingState.expectedVisibleRange = { from: newFrom, to: newTo };

                    // è®¾ç½®æ–°çš„å¯è§èŒƒå›´
                    return chart.setVisibleRange({
                        from: newFrom,
                        to: newTo
                    }).then(function() {
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        updateReplayStatus();
                        return { start: newFrom, end: newTo };
                    }).catch(function(error) {
                        console.error('è®¾ç½®å›¾è¡¨èŒƒå›´å¤±è´¥:', error);
                        // å¦‚æœè®¾ç½®å¤±è´¥ï¼Œæˆ‘ä»¬åº”è¯¥å›æ»šæœŸæœ›çš„èŒƒå›´å—ï¼Ÿæš‚æ—¶ä¸ï¼Œè®©å®ƒç»§ç»­å°è¯•
                        return null;
                    });
                } catch(e) {
                    console.error('ç§»åŠ¨å›¾è¡¨èŒƒå›´æ—¶å‡ºé”™:', e);
                    return Promise.resolve(null);
                }
            }
            
            // å¼€å§‹æ’­æ”¾å‡½æ•°
            function startPlayback() {
                // å¦‚æœå·²ç»åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
                if (isPlaying) {
                    stopPlayback();
                }
                
                // è·å–æ’­æ”¾é€Ÿåº¦
                var speed = parseInt(replaySpeedSel ? replaySpeedSel.value : 1);
                if (isNaN(speed) || speed < 1) speed = 1;
                
                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                replayPlayBtn.style.display = 'none';
                replayPauseBtn.style.display = 'inline-block';
                
                isPlaying = true;
                
                // æ¯ç§’å‰è¿› speed æ ¹Kçº¿
                playbackInterval = setInterval(function() {
                    advanceChartRange(speed).then(function(result) {
                        if (!result) {
                            console.error('æ’­æ”¾å¤±è´¥ï¼Œæ— æ³•è·å–æˆ–è®¾ç½®èŒƒå›´');
                            stopPlayback();
                        }
                    });
                }, 1000); // æ¯ç§’1æ¬¡
            }
            
            // åœæ­¢æ’­æ”¾å‡½æ•°
            function stopPlayback() {
                if (playbackInterval) {
                    clearInterval(playbackInterval);
                    playbackInterval = null;
                }
                
                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                replayPlayBtn.style.display = 'inline-block';
                replayPauseBtn.style.display = 'none';
                
                isPlaying = false;
            }
            
            // æ ¹æ®æ—¶é—´å‘¨æœŸè®¡ç®—æ¯ä¸ªbarçš„ç§’æ•°
            function calculateSecondsPerBar(interval) {
                // è§£ææ—¶é—´å‘¨æœŸå­—ç¬¦ä¸²
                var value = parseInt(interval);
                var unit = interval.replace(/[0-9]/g, '');
                
                // æ ¹æ®å•ä½è®¡ç®—ç§’æ•°
                switch(unit) {
                    case 's': // ç§’
                        return value;
                    case '': // åˆ†é’Ÿ (é»˜è®¤å•ä½)
                    case 'm': // åˆ†é’Ÿ
                        return value * 60;
                    case 'h': // å°æ—¶
                        return value * 60 * 60;
                    case 'D': // å¤©
                        return value * 86400;
                    case 'W': // å‘¨
                        return value * 86400 * 7;
                    case 'M': // æœˆ (å¤§çº¦30å¤©)
                        return value * 86400 * 30;
                    default: // é»˜è®¤ä¸ºåˆ†é’Ÿ
                        return value * 60;
                }
            }
            
            // äº¤æ˜“ç›¸å…³åŠŸèƒ½
            var buyButton = document.getElementById('buy-button');
            var sellButton = document.getElementById('sell-button');
            var closePositionButton = document.getElementById('close-position');
            var positionType = document.getElementById('position-type');
            var positionPrice = document.getElementById('position-price');
            
            // äº¤æ˜“çŠ¶æ€
            var investAmountInput = document.getElementById('invest-amount');
            var leverageSelector = document.getElementById('leverage-selector');
            var accountBalanceValue = document.getElementById('account-balance-value');

            var tradingState = {
                accountBalance: 10000.00, // åˆå§‹è´¦æˆ·ä½™é¢
                inPosition: false,
                position: {
                    type: null, // 'long' or 'short'
                    entryPrice: 0,
                    entryTime: null,
                    margin: 0, // æŠ•å…¥çš„ä¿è¯é‡‘
                    leverage: 1, // æ æ†å€æ•°
                    quantity: 0, // å¼€ä»“æ•°é‡
                    liquidationPrice: 0, // å¼ºå¹³ä»·æ ¼
                },
                liquidationLine: null, // å¼ºå¹³çº¿çš„å¼•ç”¨
                markers: [],
                replaySessionId: null,
                originalInterval: null,
                barsCount: 150,
                replayStartTime: null,
                replayEndTime: null,
                currentBarTime: null,
                expectedVisibleRange: null
            };
            
            // çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
            var statusUpdateTimer = null;
            
            // å¯åŠ¨çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
            function startStatusUpdateTimer() {
                if (statusUpdateTimer) {
                    clearInterval(statusUpdateTimer);
                }
                // æ¯2ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
                statusUpdateTimer = setInterval(updateReplayStatus, 2000);
            }
            
            // åœæ­¢çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
            function stopStatusUpdateTimer() {
                if (statusUpdateTimer) {
                    clearInterval(statusUpdateTimer);
                    statusUpdateTimer = null;
                }
            }
            
            // ä¹°å…¥æŒ‰é’®äº‹ä»¶
            if (buyButton) {
                buyButton.addEventListener('click', async function() {
                    if (tradingState.inPosition) return;

                    try {
                        const margin = parseFloat(investAmountInput.value);
                        const leverage = parseInt(leverageSelector.value);
                        const price = await getCurrentPrice();

                        if (isNaN(margin) || margin <= 0) {
                            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•å…¥é‡‘é¢');
                            return;
                        }
                        if (margin > tradingState.accountBalance) {
                            alert('æŠ•å…¥é‡‘é¢ä¸èƒ½è¶…è¿‡è´¦æˆ·ä½™é¢');
                            return;
                        }

                        // æ›´æ–°è´¦æˆ·ä½™é¢
                        tradingState.accountBalance -= margin;
                        await updateAccountBalanceUI();

                        // è®¡ç®—ä»“ä½
                        const positionValue = margin * leverage;
                        const quantity = positionValue / price;

                        // æ›´æ–°æŒä»“çŠ¶æ€
                        tradingState.inPosition = true;
                        tradingState.position = {
                            type: 'long',
                            entryPrice: price,
                            entryTime: await getCurrentBarTime(),
                            margin: margin,
                            leverage: leverage,
                            quantity: quantity,
                            liquidationPrice: calculateLiquidationPrice(price, leverage, 'long')
                        };
                        
                        // æ›´æ–°UI
                        updatePositionInfo('å¤š', price);
                        toggleTradingButtons(true);
                        drawLiquidationLine(tradingState.position.liquidationPrice);
                        addBuyMarker(price);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        updateReplayStatus();
                        startStatusUpdateTimer();
                        
                        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                        var event = new CustomEvent('position-opened', {
                            detail: { type: 'long', price: price }
                        });
                        document.dispatchEvent(event);
                    } catch (e) {
                        console.error('ä¹°å…¥æ“ä½œå¤±è´¥:', e);
                    }
                });
            }
            
            // å–å‡ºæŒ‰é’®äº‹ä»¶
            if (sellButton) {
                sellButton.addEventListener('click', async function() {
                    if (tradingState.inPosition) return;

                    try {
                        const margin = parseFloat(investAmountInput.value);
                        const leverage = parseInt(leverageSelector.value);
                        const price = await getCurrentPrice();

                        if (isNaN(margin) || margin <= 0) {
                            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•å…¥é‡‘é¢');
                            return;
                        }
                        if (margin > tradingState.accountBalance) {
                            alert('æŠ•å…¥é‡‘é¢ä¸èƒ½è¶…è¿‡è´¦æˆ·ä½™é¢');
                            return;
                        }

                        // æ›´æ–°è´¦æˆ·ä½™é¢
                        tradingState.accountBalance -= margin;
                        await updateAccountBalanceUI();

                        // è®¡ç®—ä»“ä½
                        const positionValue = margin * leverage;
                        const quantity = positionValue / price;

                        // æ›´æ–°æŒä»“çŠ¶æ€
                        tradingState.inPosition = true;
                        tradingState.position = {
                            type: 'short',
                            entryPrice: price,
                            entryTime: await getCurrentBarTime(),
                            margin: margin,
                            leverage: leverage,
                            quantity: quantity,
                            liquidationPrice: calculateLiquidationPrice(price, leverage, 'short')
                        };

                        // æ›´æ–°UI
                        updatePositionInfo('ç©º', price);
                        toggleTradingButtons(true);
                        drawLiquidationLine(tradingState.position.liquidationPrice);
                        addSellMarker(price);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        updateReplayStatus();
                        startStatusUpdateTimer();
                        
                        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                        var event = new CustomEvent('position-opened', {
                            detail: { type: 'short', price: price }
                        });
                        document.dispatchEvent(event);
                    } catch (e) {
                        console.error('å–å‡ºæ“ä½œå¤±è´¥:', e);
                    }
                });
            }
            
            // å¹³ä»“æŒ‰é’®äº‹ä»¶
            if (closePositionButton) {
                closePositionButton.addEventListener('click', async function() {
                    if (!tradingState.inPosition) return;

                    // å¦‚æœåœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
                    if (isPlaying) {
                        stopPlayback();
                    }

                    try {
                        const price = await getCurrentPrice();
                        const pnl = calculatePnL(
                            tradingState.position.type,
                            tradingState.position.entryPrice,
                            price,
                            tradingState.position.quantity
                        );

                        // æ›´æ–°è´¦æˆ·ä½™é¢
                        tradingState.accountBalance += tradingState.position.margin + pnl;
                        await updateAccountBalanceUI();

                        // ä¿å­˜äº¤æ˜“è®°å½•
                        await saveTradeRecord(price, pnl, 'closed', tradingState.position);

                        // åœ¨æ¸…é™¤çŠ¶æ€å‰ç»˜åˆ¶å¹³ä»“æ ‡è®°
                        await addClosePositionMarker(
                            tradingState.position.type,
                            tradingState.position.entryPrice,
                            price
                        );

                        // é‡ç½®æŒä»“çŠ¶æ€
                        tradingState.inPosition = false;
                        tradingState.position = {};

                        // æ›´æ–°UI
                        clearPositionInfo();
                        toggleTradingButtons(false);
                        removeLiquidationLine();

                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        updateReplayStatus();
                        stopStatusUpdateTimer();
                        
                        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                        var event = new CustomEvent('position-closed', {
                            detail: { pnl: pnl, exitPrice: price }
                        });
                        document.dispatchEvent(event);
                    } catch (e) {
                        console.error('å¹³ä»“æ“ä½œå¤±è´¥:', e);
                    }
                });
            }
            
            // è¾…åŠ©å‡½æ•° - è·å–å½“å‰ä»·æ ¼
            async function getCurrentPrice() {
                // å°è¯•ä»å›¾è¡¨è·å–æœ€æ–°ä»·æ ¼ 
                if (window.widget) {
                    try {
                        const chart = window.widget.chart();
                        const visibleRange = chart.getVisibleRange();
                        
                        // å¦‚æœæœ‰å¯è§èŒƒå›´ï¼Œä½¿ç”¨exportDataè·å–æœ€åä¸€æ ¹Kçº¿æ•°æ®
                        if (visibleRange && visibleRange.from && visibleRange.to) {
                            const data = await chart.exportData({
                                from: visibleRange.from,
                                to: visibleRange.to,
                                includeSeries: true
                            });
                            
                            // æ ¹æ®TradingViewçš„æ ¼å¼å¤„ç†è¿”å›çš„æ•°æ®
                            // æ•°æ®æ˜¯äºŒç»´æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸€è¡Œä»£è¡¨ä¸€æ ¹Kçº¿
                            // é€šå¸¸ç¬¬4ä¸ªç´¢å¼•ä½ç½®(index 4)å­˜å‚¨æ”¶ç›˜ä»·
                            if (data && Array.isArray(data.data) && data.data.length > 0) {
                                const lastIndex = data.data.length - 1;
                                const lastCandle = data.data[lastIndex];
                                
                                // å¦‚æœæ˜¯æ•°ç»„æ ¼å¼ï¼ŒæŒ‰ç…§OHLCVç»“æ„ï¼ˆç´¢å¼•4æ˜¯æ”¶ç›˜ä»·ï¼‰
                                return lastCandle[4];
                            }
                        }
                    } catch (e) {
                        console.error('è·å–å½“å‰ä»·æ ¼å¤±è´¥:', e);
                    }
                }
                
                // å¦‚æœæ— æ³•ä»å›¾è¡¨è·å–ï¼Œåˆ™ä½¿ç”¨éšæœºä»·æ ¼æ¨¡æ‹Ÿ
                return Math.round(Math.random() * 10000) / 100;
            }
            
            function calculatePnL(positionType, entryPrice, currentPrice, quantity) {
                if (positionType === 'long') {
                    return (currentPrice - entryPrice) * quantity;
                } else if (positionType === 'short') {
                    return (entryPrice - currentPrice) * quantity;
                }
                return 0;
            }

            // è®¡ç®—å¼ºå¹³ä»·æ ¼
            function calculateLiquidationPrice(entryPrice, leverage, positionType) {
                if (leverage <= 0) return 0;
                // ç»´æŒä¿è¯é‡‘ç‡ï¼Œå‚è€ƒä¸»æµäº¤æ˜“æ‰€ï¼Œé«˜æ æ†ä¸‹é€šå¸¸ä¸º0.5%
                const maintenanceMarginRate = 0.005; 
            
                if (positionType === 'long') {
                    return entryPrice * (1 - (1 / leverage) + maintenanceMarginRate);
                } else if (positionType === 'short') {
                    return entryPrice * (1 + (1 / leverage) - maintenanceMarginRate);
                }
                return 0;
            }
            
            // ç»˜åˆ¶å¼ºå¹³ä»·æ ¼çº¿
            function drawLiquidationLine(price) {
                if (!window.widget || price <= 0) return;
                removeLiquidationLine(); // å…ˆç§»é™¤æ—§çš„
            
                try {
                    tradingState.liquidationLine = window.widget.chart().createOrderLine()
                        .price(price)
                        .text(`å¼ºå¹³ä»·: ${price.toFixed(4)}`)
                        .lineColor("#FF5252")
                        .bodyBorderColor("#FF5252")
                        .bodyBackgroundColor("rgba(255, 82, 82, 0.2)")
                        .bodyTextColor("#FF5252")
                        .lineStyle(2) // è™šçº¿
                        .lineWidth(1);
                } catch (e) {
                    console.error("ç»˜åˆ¶å¼ºå¹³çº¿å¤±è´¥:", e);
                }
            }
            
            // ç§»é™¤å¼ºå¹³ä»·æ ¼çº¿
            function removeLiquidationLine() {
                if (tradingState.liquidationLine) {
                    try {
                        tradingState.liquidationLine.remove();
                    } catch (e) {
                        console.warn("ç§»é™¤å¼ºå¹³çº¿å¤±è´¥:", e);
                    }
                    tradingState.liquidationLine = null;
                }
            }
            async function updateAccountBalanceUI() {
                if (accountBalanceValue) {
                    let displayBalance = tradingState.accountBalance;
                    let pnl = 0;
                    const inPosition = tradingState.inPosition && tradingState.position.type;

                    if (inPosition) {
                        try {
                            const currentPrice = await getCurrentPrice();
                            pnl = calculatePnL(
                                tradingState.position.type,
                                tradingState.position.entryPrice,
                                currentPrice,
                                tradingState.position.quantity
                            );
                            // æ€»æƒç›Š = å¯ç”¨ä½™é¢ + ä»“ä½ä¿è¯é‡‘ + æœªå®ç°ç›ˆäº
                            displayBalance = tradingState.accountBalance + tradingState.position.margin + pnl;
                        } catch (e) {
                            console.error("æ— æ³•è®¡ç®—å®æ—¶æƒç›Š:", e);
                            // å¼‚å¸¸æ—¶å›é€€æ˜¾ç¤ºå¯ç”¨ä½™é¢
                            displayBalance = tradingState.accountBalance;
                        }
                    }
                    
                    accountBalanceValue.textContent = displayBalance.toFixed(2);
                    
                    // ä»…å½“æœ‰æŒä»“æ—¶ï¼Œæ ¹æ®æœªå®ç°ç›ˆäºæ›´æ–°é¢œè‰²
                    if (inPosition) {
                        if (pnl > 0) {
                            accountBalanceValue.classList.add('positive');
                            accountBalanceValue.classList.remove('negative');
                        } else if (pnl < 0) {
                            accountBalanceValue.classList.add('negative');
                            accountBalanceValue.classList.remove('positive');
                        } else {
                            accountBalanceValue.classList.remove('positive', 'negative');
                        }
                    } else {
                        // æ²¡æœ‰æŒä»“æ—¶ï¼Œç§»é™¤é¢œè‰²
                        accountBalanceValue.classList.remove('positive', 'negative');
                    }
                }
            }
            function updatePositionInfo(typeText, price) {
                if (positionType && positionPrice) {
                    positionType.textContent = typeText;
                    positionPrice.textContent = price.toFixed(2);
                    positionType.style.color = typeText === 'å¤š' ? '#26a69a' : '#ef5350';
                }
            }
 
            function clearPositionInfo() {
                if (positionType && positionPrice) {
                    positionType.textContent = '';
                    positionPrice.textContent = '';
                }
            }
 
            function toggleTradingButtons(inPosition) {
                if (buyButton && sellButton && closePositionButton) {
                    buyButton.disabled = inPosition;
                    sellButton.disabled = inPosition;
                    closePositionButton.disabled = !inPosition;
                }
            }
 
            function showPnLResult(pnl) {
                var color = pnl >= 0 ? '#26a69a' : '#ef5350';
                var sign = pnl >= 0 ? '+' : '';
                alert('äº¤æ˜“ç»“æœ: ' + sign + pnl.toFixed(2));
            }
 
            // å›¾è¡¨æ ‡è®°ç›¸å…³å‡½æ•°
 
            // æ¸…ç©ºæ‰€æœ‰å›¾è¡¨æ ‡è®°å’Œç»˜å›¾
            function clearAllDrawings() {
                if (!window.widget) return;
                try {
                    const chart = window.widget.chart();
                    const shapeIds = chart.getAllShapes().map(shape => shape.id);
                    shapeIds.forEach(id => chart.removeEntity(id));
                    tradingState.markers = []; // æ¸…ç©ºæˆ‘ä»¬è‡ªå·±ä¿å­˜çš„æ ‡è®°ID
                    console.log('å·²æ¸…ç©ºæ‰€æœ‰å›¾è¡¨æ ‡è®°å’Œç»˜å›¾');
                } catch (e) {
                    console.error('æ¸…ç©ºå›¾è¡¨æ ‡è®°å¤±è´¥:', e);
                }
            }

            // æ·»åŠ ä¹°å…¥æ ‡è®°ï¼ˆä¸Šç®­å¤´ï¼‰
            async function addBuyMarker(price) {
                if (!window.widget) return;
 
                try {
                    const chart = window.widget.chart();
                    const currentTime = await getCurrentBarTime();
 
                    // è®°å½•å…¥åœºæ—¶é—´
                    tradingState.entryTime = currentTime;
 
                    // åˆ›å»ºä¹°å…¥æ ‡è®°ï¼ˆå‘ä¸Šç®­å¤´ï¼Œç»¿è‰²ï¼‰
                    //const markerId = chart.createShape({
                    //    time: currentTime,
                    //    price: price,
                    //    shape: 'arrow_up',
                    //    text: 'ä¹°å…¥',
                    //    lock: true,
                    //    disableSelection: true,
                    //    disableSave: false,
                    //    disableUndo: false,
                    //    overrides: {
                    //        color: '#26a69a',   // ç»¿è‰²
                    //        textColor: '#26a69a',
                    //        fontsize: 12,
                    //        bold: true,
                    //        size: 2
                    //    }
                    //});
 
                    const markerId = chart.createShape(
                        { time: currentTime, channel: "low" },
                        { shape: "arrow_up", text: "Buy" }
                    );
                    // ä¿å­˜æ ‡è®°ID
                    tradingState.markers.push(markerId);
 
                    console.log('æ·»åŠ ä¹°å…¥æ ‡è®°æˆåŠŸï¼ŒID:', markerId, 'ä»·æ ¼:', price, 'æ—¶é—´:', new Date(currentTime * 1000).toLocaleString());
                } catch (e) {
                    console.error('æ·»åŠ ä¹°å…¥æ ‡è®°å¤±è´¥:', e);
                }
            }
 
            // æ·»åŠ å–å‡ºæ ‡è®°ï¼ˆä¸‹ç®­å¤´ï¼‰
            async function addSellMarker(price) {
                if (!window.widget) return;
 
                try {
                    const chart = window.widget.chart();
                    const currentTime = await getCurrentBarTime();
 
                    // è®°å½•å…¥åœºæ—¶é—´
                    tradingState.entryTime = currentTime;
 
                    // åˆ›å»ºå–å‡ºæ ‡è®°ï¼ˆå‘ä¸‹ç®­å¤´ï¼Œçº¢è‰²ï¼‰
                    //const markerId = chart.createShape({
                    //    time: currentTime,
                    //    price: price,
                    //    shape: 'arrow_down',
                    //    text: 'å–å‡º',
                    //    lock: true,
                    //    disableSelection: true,
                    //    disableSave: false,
                    //    disableUndo: false,
                    //    overrides: {
                    //        color: '#ef5350',   // çº¢è‰²
                    //        textColor: '#ef5350',
                    //        fontsize: 12,
                    //        bold: true,
                    //        size: 2
                    //    }
                    //});
 
                    const markerId = chart.createShape(
                        { time: currentTime, channel: "high" },
                        { shape: "arrow_down", text: "Sell" }
                    );
                    // ä¿å­˜æ ‡è®°ID
                    tradingState.markers.push(markerId);
 
                    console.log('æ·»åŠ å–å‡ºæ ‡è®°æˆåŠŸï¼ŒID:', markerId, 'ä»·æ ¼:', price, 'æ—¶é—´:', new Date(currentTime * 1000).toLocaleString());
                } catch (e) {
                    console.error('æ·»åŠ å–å‡ºæ ‡è®°å¤±è´¥:', e);
                }
            }
 
            // æ·»åŠ å¹³ä»“åŒºåŸŸæ ‡è®°
            async function addClosePositionMarker(positionType, entryPrice, exitPrice) {
                if (!window.widget || !tradingState.position.entryTime) return;
 
                try {
                    const chart = window.widget.chart();
                    // è·å–å½“å‰Kçº¿æ—¶é—´ï¼ˆç°åœ¨è¿”å› Promiseï¼‰
                    const currentTime = await getCurrentBarTime();
 
                    // ç¡®å®šé¢œè‰²ï¼ˆæ ¹æ®ç›ˆäºçŠ¶æ€ä½¿ç”¨ä¸åŒæ·±æµ…çš„é¢œè‰²ï¼‰
                    let color;
                    // åˆ¤æ–­æ˜¯å¦ç›ˆåˆ©
                    const isProfitable = positionType === 'long' ? exitPrice > entryPrice : exitPrice < entryPrice;
 
                    // æ ¹æ®ä»“ä½ç±»å‹å’Œç›ˆäºçŠ¶æ€ç¡®å®šé¢œè‰²
                    if (positionType === 'long') {
                        // å¤šå•ï¼šç›ˆåˆ©ç”¨è¾ƒæµ…ç»¿è‰²ï¼ŒäºæŸç”¨è¾ƒæ·±ç»¿è‰²
                        color = isProfitable ? '#4CAF50' : '#1B5E20';
                    } else {
                        // ç©ºå•ï¼šç›ˆåˆ©ç”¨è¾ƒæµ…çº¢è‰²ï¼ŒäºæŸç”¨è¾ƒæ·±çº¢è‰²
                        color = isProfitable ? '#F44336' : '#B71C1C';
                    }
 
                    const opacity = 0.2; // é€æ˜åº¦
                    const borderOpacity = 0.8; // è¾¹æ¡†é€æ˜åº¦
 
                    // åˆ›å»ºåŒºåŸŸæ ‡è®°
                    const markerId = chart.createMultipointShape([
                        { time: tradingState.position.entryTime, price: entryPrice },
                        { time: currentTime, price: exitPrice }
                    ], {
                        shape: 'date_and_price_range',
                        lock: false,
                        disableSelection: true,
                        disableSave: false,
                        disableUndo: false,
                        zOrder: 'bottom',  // æ”¾åœ¨ä¸‹å±‚
                        overrides: {
                            backgroundColor: color,
                            backgroundTransparency: Math.round(opacity * 100),
                            borderColor: color,
                            borderWidth: 1,
                            borderTransparency: Math.round((1 - borderOpacity) * 100),
                            extendLeft: false,
                            extendRight: false
                        }
                    });
 
                    // ä¿å­˜æ ‡è®°ID
                    tradingState.markers.push(markerId);
 
                    console.log('æ·»åŠ å¹³ä»“åŒºåŸŸæ ‡è®°æˆåŠŸï¼ŒID:', markerId, 'ä»æ—¶é—´:', new Date(tradingState.position.entryTime * 1000).toLocaleString(),
                                'åˆ°æ—¶é—´:', new Date(currentTime * 1000).toLocaleString());
                } catch (e) {
                    console.error('æ·»åŠ å¹³ä»“åŒºåŸŸæ ‡è®°å¤±è´¥:', e);
                }
            }
 
            // è·å–å½“å‰Kçº¿çš„æ—¶é—´ - è¿”å› Promise
            function getCurrentBarTime() {
                if (!window.widget) {
                    return Promise.resolve(Math.floor(Date.now() / 1000));
                }
                
                try {
                    const chart = window.widget.chart();
                    
                    // ä½¿ç”¨exportDataæ–¹æ³•è·å–æœ€åä¸€æ ¹Kçº¿
                    const visibleRange = chart.getVisibleRange();
                    
                    // å¦‚æœæœ‰å¯è§èŒƒå›´ï¼Œå¯¼å‡ºæ•°æ®å¹¶è·å–æœ€åä¸€æ ¹Kçº¿æ—¶é—´
                    if (visibleRange && visibleRange.to) {
                        // å¦‚æœæœ‰å¯è§èŒƒå›´ä½†æ— æ³•è·å–å®Œæ•´æ•°æ®ï¼Œä½¿ç”¨å¯è§èŒƒå›´çš„ç»“æŸæ—¶é—´
                        return Promise.resolve(visibleRange.to);
                    } else {
                        // å¦‚æœæ— æ³•è·å–å¯è§èŒƒå›´ï¼Œè¿”å›å½“å‰æ—¶é—´æˆ³
                        return Promise.resolve(Math.floor(Date.now() / 1000));
                    }
                } catch (e) {
                    console.error('è·å–å½“å‰Kçº¿æ—¶é—´å¤±è´¥:', e);
                    return Promise.resolve(Math.floor(Date.now() / 1000));
                }
            }
            // æä¾›å…¨å±€æ–¹æ³•ä¾›ReplayæŒ‰é’®è°ƒç”¨
            window.toggleReplayMenu = function() {
                if (menu.style.display === 'none') {
                    if (!hasMoved) {
                        // æœªæ‹–åŠ¨è¿‡ï¼Œå›åˆ°åº•éƒ¨å±…ä¸­
                        menu.style.left = '50%';
                        menu.style.bottom = '40px';
                        menu.style.top = 'auto';
                        menu.style.transform = 'translateX(-50%)';
                    }
                    menu.style.display = 'flex';
                } else {
                    menu.style.display = 'none';
                }
            }

            // äº¤æ˜“ç»Ÿè®¡åŠŸèƒ½
            const statsButton = document.getElementById('stats-button');
            const statsModal = document.getElementById('stats-modal');
            const statsModalClose = document.getElementById('stats-modal-close');
            
            if (statsButton) {
                statsButton.addEventListener('click', function() {
                    // è·å–å½“å‰å›¾è¡¨çš„symbolå’Œinterval
                    let symbol = '';
                    let interval = '';
                    
                    try {
                        if (window.widget) {
                            const symbol_interval = window.widget.symbolInterval();
                            symbol = symbol_interval.symbol;
                            interval = symbol_interval.interval;
                        }
                    } catch (e) {
                        console.error('è·å–å½“å‰å›¾è¡¨ä¿¡æ¯å¤±è´¥:', e);
                    }
                    
                    // æ„å»ºæŸ¥è¯¢URL
                    const queryParams = new URLSearchParams();
                    if (symbol) queryParams.append('symbol', symbol);
                    if (interval) queryParams.append('interval', interval);
                    
                    // è¯·æ±‚ç»Ÿè®¡æ•°æ®
                    fetch('/trade-statistics?' + queryParams.toString())
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'ok') {
                                // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                                updateStatsModal(data.data);
                                // æ˜¾ç¤ºå¼¹çª—
                                statsModal.style.display = 'block';
                            } else {
                                console.error('è·å–äº¤æ˜“ç»Ÿè®¡å¤±è´¥:', data.message);
                                alert('è·å–äº¤æ˜“ç»Ÿè®¡å¤±è´¥: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('è¯·æ±‚äº¤æ˜“ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™:', error);
                            alert('è¯·æ±‚äº¤æ˜“ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™');
                        });
                });
            }
            
            // å…³é—­ç»Ÿè®¡å¼¹çª—
            if (statsModalClose) {
                statsModalClose.addEventListener('click', function() {
                    statsModal.style.display = 'none';
                });
            }
            
            // ç‚¹å‡»å¼¹çª—å¤–åŒºåŸŸå…³é—­å¼¹çª—
            window.addEventListener('click', function(event) {
                if (event.target === statsModal) {
                    statsModal.style.display = 'none';
                }
                if (event.target === historyModal) {
                    historyModal.style.display = 'none';
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡å¼¹çª—å†…å®¹
            function updateStatsModal(stats) {
                document.getElementById('total-trades').textContent = stats.total_trades;
                document.getElementById('profitable-trades').textContent = stats.profitable_trades;
                document.getElementById('win-rate').textContent = stats.win_rate + '%';
                
                // è®¾ç½®ç›ˆäºå€¼æ ·å¼
                const totalPnlElement = document.getElementById('total-pnl');
                totalPnlElement.textContent = stats.total_pnl > 0 ? '+' + stats.total_pnl.toFixed(2) : stats.total_pnl.toFixed(2);
                totalPnlElement.className = 'stats-value ' + (stats.total_pnl >= 0 ? 'positive' : 'negative');
                
                // è®¾ç½®ç›ˆåˆ©ç‡æ ·å¼
                const profitRateElement = document.getElementById('profit-rate');
                profitRateElement.textContent = stats.profit_rate.toFixed(2) + '%';
                profitRateElement.className = 'stats-value ' + (stats.profit_rate >= 0 ? 'positive' : 'negative');
            }

            // å†å²å›æ”¾è®°å½•åŠŸèƒ½
            const historyButton = document.getElementById('history-button');
            const historyModal = document.getElementById('history-modal');
            const historyModalClose = document.getElementById('history-modal-close');
            const historyList = document.getElementById('history-list');
            const historyLoading = document.getElementById('history-loading');
            const historyEmpty = document.getElementById('history-empty');
            
            // å†å²è®°å½•åˆ†é¡µçŠ¶æ€
            const historyState = {
                page: 1,
                pageSize: 10,
                loading: false,
                hasMore: true,
                total: 0,
                client_id: 'tv_proxy', // å¯ä»¥ä»ç”¨æˆ·é…ç½®ä¸­è·å–
                user_id: 'public_user'      // å¯ä»¥ä»ç”¨æˆ·é…ç½®ä¸­è·å–
            };
            
            // æ‰“å¼€å†å²è®°å½•å¼¹çª—
            if (historyButton) {
                historyButton.addEventListener('click', function() {
                    // æ˜¾ç¤ºå¼¹çª—
                    historyModal.style.display = 'block';
                    
                    // é‡ç½®åˆ†é¡µçŠ¶æ€
                    historyState.page = 1;
                    historyState.hasMore = true;
                    historyList.innerHTML = '';
                    
                    // åŠ è½½ç¬¬ä¸€é¡µæ•°æ®
                    loadHistoryData();
                });
            }
            
            // å…³é—­å†å²è®°å½•å¼¹çª—
            if (historyModalClose) {
                historyModalClose.addEventListener('click', function() {
                    historyModal.style.display = 'none';
                });
            }
            
            // åŠ è½½å†å²è®°å½•æ•°æ®
            function loadHistoryData() {
                if (historyState.loading || !historyState.hasMore) return;
                
                historyState.loading = true;
                historyLoading.style.display = 'flex';
                historyEmpty.style.display = 'none';
                
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const queryParams = new URLSearchParams();
                queryParams.append('page', historyState.page);
                queryParams.append('page_size', historyState.pageSize);
                if (historyState.client_id) queryParams.append('client_id', historyState.client_id);
                if (historyState.user_id) queryParams.append('user_id', historyState.user_id);
                
                // è¯·æ±‚å†å²è®°å½•æ•°æ®
                fetch('/api/replay/sessions?' + queryParams.toString())
                    .then(response => response.json())
                    .then(data => {
                        historyState.loading = false;
                        historyLoading.style.display = 'none';
                        
                        if (data.status === 'ok') {
                            // æ›´æ–°æ€»æ•°å’Œåˆ†é¡µä¿¡æ¯
                            historyState.total = data.total;
                            historyState.hasMore = historyState.page * historyState.pageSize < data.total;
                            
                            // æ˜¾ç¤ºæ•°æ®
                            if (data.data.length === 0 && historyState.page === 1) {
                                // æ²¡æœ‰æ•°æ®
                                historyEmpty.style.display = 'block';
                            } else {
                                // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
                                renderHistoryItems(data.data);
                                
                                // æ›´æ–°é¡µç 
                                historyState.page++;
                            }
                        } else {
                            console.error('è·å–å†å²è®°å½•å¤±è´¥:', data.message);
                            alert('è·å–å†å²è®°å½•å¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        historyState.loading = false;
                        historyLoading.style.display = 'none';
                        console.error('è¯·æ±‚å†å²è®°å½•æ•°æ®æ—¶å‡ºé”™:', error);
                        alert('è¯·æ±‚å†å²è®°å½•æ•°æ®æ—¶å‡ºé”™');
                    });
            }
            
            // æ¸²æŸ“å†å²è®°å½•é¡¹
            function renderHistoryItems(items) {
                items.forEach(item => {
                    const historyItem = createHistoryItem(item);
                    historyList.appendChild(historyItem);
                });
            }
            
            // åˆ›å»ºå†å²è®°å½•é¡¹å…ƒç´ 
            function createHistoryItem(item) {
                const itemElement = document.createElement('div');
                itemElement.className = 'history-item';
                
                // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
                const startDate = formatTimestamp(item.start_time);
                const endDate = item.end_time ? formatTimestamp(item.end_time) : 'è‡³ä»Š';
                
                // åˆ›å»ºå¤´éƒ¨
                const header = document.createElement('div');
                header.className = 'history-item-header';
                
                const symbol = document.createElement('div');
                symbol.className = 'history-item-symbol';
                symbol.textContent = item.symbol + ' (' + item.interval + ')';
                
                const date = document.createElement('div');
                date.className = 'history-item-date';
                date.textContent = startDate + ' è‡³ ' + endDate;
                
                header.appendChild(symbol);
                header.appendChild(date);
                
                // åˆ›å»ºè¯¦æƒ…éƒ¨åˆ†
                const details = document.createElement('div');
                details.className = 'history-item-details';
                
                // æ·»åŠ è¯¦æƒ…é¡¹ - ä¼˜å…ˆä½¿ç”¨å¸‚åœºä»·æ ¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨äº¤æ˜“ä»·æ ¼
                addDetailItem(details, 'ä»·æ ¼å˜åŠ¨', formatPriceChange(
                    item.market_price_start || item.price_start, 
                    item.market_price_end || item.price_end, 
                    item.market_price_change_percent || item.price_change_percent
                ));
                addDetailItem(details, 'æ€»ç›ˆäº', formatPnL(item.total_pnl));
                addDetailItem(details, 'äº¤æ˜“æ¬¡æ•°', item.trade_count || 0);
                addDetailItem(details, 'æŒä»“æ—¶é•¿', formatHoldingTime(item.hold_time_length));
                
                // åˆ›å»ºæ“ä½œæŒ‰é’®
                const actions = document.createElement('div');
                actions.className = 'history-item-actions';
                
                const replayButton = document.createElement('button');
                replayButton.className = 'history-action-btn history-action-replay';
                replayButton.textContent = 'é‡æ”¾';
                replayButton.addEventListener('click', function() {
                    replayHistorySession(item);
                });
                
                actions.appendChild(replayButton);
                
                // ç»„è£…å†å²è®°å½•é¡¹
                itemElement.appendChild(header);
                itemElement.appendChild(details);
                itemElement.appendChild(actions);
                
                return itemElement;
            }
            
            // æ·»åŠ è¯¦æƒ…é¡¹
            function addDetailItem(container, label, value, valueClass = '') {
                const detailItem = document.createElement('div');
                detailItem.className = 'history-detail';
                
                const labelElement = document.createElement('span');
                labelElement.className = 'history-detail-label';
                labelElement.textContent = label;
                
                const valueElement = document.createElement('span');
                valueElement.className = 'history-detail-value ' + valueClass;
                valueElement.innerHTML = value; // ä½¿ç”¨innerHTMLæ”¯æŒHTMLæ ¼å¼
                
                detailItem.appendChild(labelElement);
                detailItem.appendChild(valueElement);
                
                container.appendChild(detailItem);
            }
            
            // æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå¯è¯»æ—¥æœŸ
            function formatTimestamp(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp * 1000);
                return date.toLocaleString();
            }
            
            // æ ¼å¼åŒ–ä»·æ ¼å˜åŠ¨
            function formatPriceChange(startPrice, endPrice, changePercent) {
                if (!startPrice || !endPrice) return 'N/A';
                
                const change = endPrice - startPrice;
                const sign = change >= 0 ? '+' : '';
                const percentStr = changePercent ? 
                    `(${sign}${changePercent.toFixed(2)}%)` : 
                    `(${sign}${((change / startPrice) * 100).toFixed(2)}%)`;
                
                const valueClass = change >= 0 ? 'positive' : 'negative';
                
                return `${sign}${change.toFixed(2)} ${percentStr}`;
            }
            
            // æ ¼å¼åŒ–ç›ˆäº
            function formatPnL(pnl) {
                if (pnl === undefined || pnl === null) return 'N/A';
                
                const sign = pnl >= 0 ? '+' : '';
                const valueClass = pnl >= 0 ? 'positive' : 'negative';
                
                return `<span class="${valueClass}">${sign}${pnl.toFixed(2)}</span>`;
            }
            
            // æ ¼å¼åŒ–æŒä»“æ—¶é—´
            function formatHoldingTime(seconds) {
                if (!seconds) return 'N/A';
                
                if (seconds < 60) {
                    return `${seconds}ç§’`;
                } else if (seconds < 3600) {
                    return `${Math.floor(seconds / 60)}åˆ†é’Ÿ`;
                } else if (seconds < 86400) {
                    return `${Math.floor(seconds / 3600)}å°æ—¶${Math.floor((seconds % 3600) / 60)}åˆ†é’Ÿ`;
                } else {
                    return `${Math.floor(seconds / 86400)}å¤©${Math.floor((seconds % 86400) / 3600)}å°æ—¶`;
                }
            }
            
            // é‡æ”¾å†å²ä¼šè¯
            async function replayHistorySession(session) {
                // ç»“æŸå½“å‰å›æ”¾ä¼šè¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                await finishCurrentReplaySession();
                
                // å…³é—­å†å²è®°å½•å¼¹çª—
                historyModal.style.display = 'none';
                
                // æ‰“å¼€å›æ”¾èœå•
                menu.style.display = 'flex';
                // è®¾ç½®å‘¨æœŸ
                const chart = window.widget.chart();
                // åˆ‡æ¢åˆ°å¯¹åº”çš„äº¤æ˜“å¯¹å’Œå‘¨æœŸ
                chart.setSymbol(session.symbol, function() {
                    console.log('äº¤æ˜“å¯¹åˆ‡æ¢æˆåŠŸ:', session.symbol);
                    chart.setResolution(session.interval, function() {
                        console.log('æ—¶é—´å‘¨æœŸè®¾ç½®æˆåŠŸ:', session.interval);
                        
                        // è®¾ç½®å›¾è¡¨èŒƒå›´
                        setChartRangeFromTimestamp(session.start_time, session.bars_count || 150);
                        
                        // ä¿å­˜å›æ”¾ç›¸å…³ä¿¡æ¯
                        tradingState.replaySessionId = session.session_uuid;
                        tradingState.replayStartTime = session.start_time;
                        tradingState.barsCount = session.bars_count || 150;
                        tradingState.originalInterval = session.interval;
                        
                        // è®¡ç®—å›æ”¾ç»“æŸæ—¶é—´
                        const chart = window.widget.chart();
                        const interval = chart.resolution();
                        const secondsPerBar = calculateSecondsPerBar(interval);
                        tradingState.replayEndTime = session.start_time + (session.bars_count || 150) * secondsPerBar;
                        tradingState.currentBarTime = session.start_time;
                        
                        // æ¸…ç©ºäº¤æ˜“çŠ¶æ€
                        if (tradingState.inPosition) {
                            tradingState.inPosition = false;
                            tradingState.positionType = null;
                            tradingState.entryPrice = 0;
                            clearPositionInfo();
                            toggleTradingButtons(false);
                        }
                        
                        // åŠ è½½äº¤æ˜“è®°å½•å¹¶æ·»åŠ æ ‡è®°
                        loadTradesAndAddMarkers(session.session_uuid);
                    });
                });
            }
            
            // åŠ è½½äº¤æ˜“è®°å½•å¹¶æ·»åŠ æ ‡è®°
            function loadTradesAndAddMarkers(sessionId) {
                if (!sessionId || !window.widget) return;
                
                // è¯·æ±‚ä¼šè¯è¯¦æƒ…ï¼ŒåŒ…å«äº¤æ˜“è®°å½•
                fetch(`/api/replay/sessions/${sessionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok' && data.data && data.data.trades) {
                            const trades = data.data.trades;
                            console.log(`åŠ è½½åˆ° ${trades.length} æ¡äº¤æ˜“è®°å½•`);
                            
                            // æ¸…é™¤ç°æœ‰çš„æ ‡è®°
                            clearAllMarkers();
                            
                            // æ·»åŠ äº¤æ˜“æ ‡è®°
                            trades.forEach(trade => {
                                addHistoricalTradeMarkers(trade);
                            });
                        } else {
                            console.error('æœªèƒ½åŠ è½½äº¤æ˜“è®°å½•:', data.message || 'æœªçŸ¥é”™è¯¯');
                        }
                    })
                    .catch(error => {
                        console.error('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥:', error);
                    });
            }
            
            // æ¸…é™¤æ‰€æœ‰æ ‡è®°
            function clearAllMarkers() {
                if (!window.widget) return;
                
                try {
                    const chart = window.widget.chart();
                    
                    // å¦‚æœæœ‰ä¿å­˜çš„æ ‡è®°ï¼Œæ¸…é™¤å®ƒä»¬
                    if (tradingState.markers && tradingState.markers.length > 0) {
                        tradingState.markers.forEach(markerId => {
                            try {
                                chart.removeEntity(markerId);
                            } catch (e) {
                                console.warn('åˆ é™¤æ ‡è®°å¤±è´¥:', e);
                            }
                        });
                        
                        // é‡ç½®æ ‡è®°æ•°ç»„
                        tradingState.markers = [];
                    }
                } catch (e) {
                    console.error('æ¸…é™¤æ ‡è®°æ—¶å‡ºé”™:', e);
                }
            }
            
            // ä¸ºå†å²äº¤æ˜“æ·»åŠ æ ‡è®°
            async function addHistoricalTradeMarkers(trade) {
                if (!window.widget) return;

                try {
                    const chart = window.widget.chart();

                    // æ·»åŠ å…¥åœºæ ‡è®°
                    let entryMarkerId;
                    if (trade.position_type === 'long') {
                        // å¤šå•å…¥åœºæ ‡è®°ï¼ˆå‘ä¸Šç®­å¤´ï¼Œç»¿è‰²ï¼‰
                        entryMarkerId = await chart.createShape(
                            { time: trade.entry_time, channel: "low" },
                            { shape: "arrow_up", text: "Buy" }
                        );
                    } else {
                        // ç©ºå•å…¥åœºæ ‡è®°ï¼ˆå‘ä¸‹ç®­å¤´ï¼Œçº¢è‰²ï¼‰
                        entryMarkerId = await chart.createShape(
                            { time: trade.entry_time, channel: "high" },
                            { shape: "arrow_down", text: "Sell" }
                        );
                    }

                    // ä¿å­˜æ ‡è®°ID
                    if (entryMarkerId) {
                        tradingState.markers.push(entryMarkerId);
                    }

                    // ç¡®å®šäº¤æ˜“åŒºåŸŸé¢œè‰²ï¼ˆæ ¹æ®ç›ˆäºçŠ¶æ€ï¼‰
                    const isProfitable = trade.pnl > 0;
                    let color;

                    // æ ¹æ®ä»“ä½ç±»å‹å’Œç›ˆäºçŠ¶æ€ç¡®å®šé¢œè‰²
                    if (trade.position_type === 'long') {
                        // å¤šå•ï¼šç›ˆåˆ©ç”¨è¾ƒæµ…ç»¿è‰²ï¼ŒäºæŸç”¨è¾ƒæ·±ç»¿è‰²
                        color = isProfitable ? '#4CAF50' : '#1B5E20';
                    } else {
                        // ç©ºå•ï¼šç›ˆåˆ©ç”¨è¾ƒæµ…çº¢è‰²ï¼ŒäºæŸç”¨è¾ƒæ·±çº¢è‰²
                        color = isProfitable ? '#F44336' : '#B71C1C';
                    }

                    const opacity = 0.2; // é€æ˜åº¦
                    const borderOpacity = 0.8; // è¾¹æ¡†é€æ˜åº¦

                    // æ·»åŠ äº¤æ˜“åŒºåŸŸæ ‡è®°
                    const areaMarkerId = await chart.createMultipointShape([
                        { time: trade.entry_time, price: trade.entry_price },
                        { time: trade.exit_time, price: trade.exit_price }
                    ], {
                        shape: 'date_and_price_range',
                        lock: true,
                        disableSelection: true,
                        disableSave: false,
                        disableUndo: false,
                        zOrder: 'bottom',  // æ”¾åœ¨ä¸‹å±‚
                        overrides: {
                            backgroundColor: color,
                            backgroundTransparency: Math.round(opacity * 100),
                            borderColor: color,
                            borderWidth: 1,
                            borderTransparency: Math.round((1 - borderOpacity) * 100),
                            extendLeft: false,
                            extendRight: false,
                            text: `PnL: ${trade.pnl > 0 ? '+' : ''}${trade.pnl.toFixed(2)}`
                        }
                    });

                    if (areaMarkerId) {
                        tradingState.markers.push(areaMarkerId);
                    }
                    
                    console.log('å†å²äº¤æ˜“æ ‡è®°æ·»åŠ æˆåŠŸ');
                } catch (e) {
                    console.error('æ·»åŠ å†å²äº¤æ˜“æ ‡è®°å¤±è´¥:', e);
                }
            }
            
            // ç›‘å¬æ¨¡æ€æ¡†æ»šåŠ¨ï¼Œå®ç°ä¸‹æ»‘åŠ è½½æ›´å¤š
            if (historyModal) {
                const modalBody = historyModal.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.addEventListener('scroll', function() {
                        // è®¡ç®—æ»šåŠ¨ä½ç½®
                        const scrollHeight = modalBody.scrollHeight;
                        const scrollTop = modalBody.scrollTop;
                        const clientHeight = modalBody.clientHeight;
                        
                        // å½“æ»šåŠ¨åˆ°åº•éƒ¨æ—¶åŠ è½½æ›´å¤š
                        if (scrollHeight - scrollTop - clientHeight < 50 && historyState.hasMore && !historyState.loading) {
                            loadHistoryData();
                        }
                    });
                }
            }

            
            // æ¢å¤åŸå§‹å‘¨æœŸæŒ‰é’®
            const restoreIntervalButton = document.getElementById('restore-interval');
            if (restoreIntervalButton) {
                restoreIntervalButton.addEventListener('click', function() {
                    if (tradingState.originalInterval) {
                        // æ¢å¤åˆ°åŸå§‹å‘¨æœŸ
                        const chart = window.widget.chart();
                        chart.setResolution(tradingState.originalInterval);
                        
                        // éšè—æŒ‰é’®
                        this.style.display = 'none';
                        
                        // å¦‚æœæœ‰å›æ”¾èµ·å§‹æ—¶é—´ï¼Œé‡æ–°è®¾ç½®èŒƒå›´
                        if (tradingState.replayStartTime) {
                            setChartRangeFromTimestamp(tradingState.replayStartTime, tradingState.barsCount);
                        }
                    }
                });
            }

            // æ›´æ–°å›æ”¾çŠ¶æ€æ˜¾ç¤º
            async function updateReplayStatus() {
                const remainingBarsElement = document.getElementById('remaining-bars-value');
                const currentPnlElement = document.getElementById('current-pnl-value');
                const currentPnlContainer = document.getElementById('current-pnl');
                
                // æ›´æ–°å‰©ä½™Kçº¿æ•°
                if (remainingBarsElement && tradingState.replayEndTime) {
                    try {
                        const chart = window.widget.chart();
                        const interval = chart.resolution();
                        const secondsPerBar = calculateSecondsPerBar(interval);
                        
                        // è·å–å½“å‰Kçº¿æ—¶é—´
                        let currentBarTime = tradingState.currentBarTime;
                        if (!currentBarTime) {
                            const visibleRange = chart.getVisibleRange();
                            if (visibleRange && visibleRange.to) {
                                currentBarTime = visibleRange.to;
                            } else {
                                currentBarTime = Math.floor(Date.now() / 1000);
                            }
                        }
                        
                        // è®¡ç®—å‰©ä½™Kçº¿æ•°
                        const remainingSeconds = tradingState.replayEndTime - currentBarTime;
                        const remainingBars = Math.max(0, Math.floor(remainingSeconds / secondsPerBar));
                        
                        remainingBarsElement.textContent = remainingBars;
                        
                        // æ ¹æ®å‰©ä½™æ•°é‡è®¾ç½®é¢œè‰²
                        if (remainingBars <= 10) {
                            remainingBarsElement.className = 'status-value warning';
                        } else if (remainingBars <= 50) {
                            remainingBarsElement.className = 'status-value';
                        } else {
                            remainingBarsElement.className = 'status-value';
                        }
                    } catch (e) {
                        console.error('æ›´æ–°å‰©ä½™Kçº¿æ•°å¤±è´¥:', e);
                        remainingBarsElement.textContent = '--';
                    }
                }
                
                // æ›´æ–°å½“å‰ç›ˆäºï¼ˆå¦‚æœæœ‰æŒä»“ï¼‰
                if (currentPnlElement && currentPnlContainer && tradingState.inPosition) {
                    try {
                        const currentPrice = await getCurrentPrice();
                        const pnl = calculatePnL(tradingState.position.type, tradingState.position.entryPrice, currentPrice, tradingState.position.quantity);
                        const pnlPercent = (pnl / tradingState.position.margin) * 100;
                        
                        currentPnlElement.textContent = `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)`;
                        currentPnlElement.className = 'status-value ' + (pnl >= 0 ? 'positive' : 'negative');
                        currentPnlContainer.style.display = 'flex';

                        // å¼ºå¹³æ£€æµ‹
                        if ( (tradingState.position.type === 'long' && currentPrice <= tradingState.position.liquidationPrice) ||
                             (tradingState.position.type === 'short' && currentPrice >= tradingState.position.liquidationPrice) )
                        {
                            // ç«‹å³è®¾ç½®çŠ¶æ€é˜²æ­¢é‡å…¥
                            const positionToLiquidate = tradingState.position;
                            tradingState.inPosition = false;

                            if (isPlaying) {
                                stopPlayback();
                            }
                            alert('ä»“ä½å·²è¢«å¼ºåˆ¶å¹³ä»“ï¼');
                            
                            // åœ¨æ¸…é™¤çŠ¶æ€å‰ç»˜åˆ¶å¹³ä»“æ ‡è®°
                            await addClosePositionMarker(
                                positionToLiquidate.type,
                                positionToLiquidate.entryPrice,
                                currentPrice
                            );
                            
                            // ä¿è¯é‡‘å…¨éƒ¨æŸå¤±ï¼Œä¸éœ€è¦æ›´æ–°ä½™é¢
                            await saveTradeRecord(currentPrice, -positionToLiquidate.margin, 'liquidated', positionToLiquidate);
                            
                            // é‡ç½®çŠ¶æ€
                            tradingState.position = {};
                            clearPositionInfo();
                            toggleTradingButtons(false);
                            removeLiquidationLine();
                            stopStatusUpdateTimer();
                        }

                    } catch (e) {
                        console.error('æ›´æ–°ç›ˆäºæ˜¾ç¤ºå¤±è´¥:', e);
                        currentPnlContainer.style.display = 'none';
                    }
                } else if (currentPnlContainer) {
                    currentPnlContainer.style.display = 'none';
                }

                // æ›´æ–°è´¦æˆ·ä½™é¢UI
                await updateAccountBalanceUI();
            }

            async function saveTradeRecord(exitPrice, pnl, status, position) {
                const chart = window.widget.chart();
                const symbol_interval = window.widget.symbolInterval();
                const symbol = symbol_interval.symbol;
                const interval = symbol_interval.interval;
                const currentTime = await getCurrentBarTime();

                const isFirstTrade = !tradingState.replaySessionId;

                const tradeData = {
                    symbol: symbol,
                    position_type: position.type,
                    entry_time: position.entryTime,
                    exit_time: currentTime,
                    entry_price: position.entryPrice,
                    exit_price: exitPrice,
                    quantity: position.quantity,
                    leverage: position.leverage,
                    margin: position.margin,
                    pnl: pnl,
                    status: status,
                    timestamp: Math.floor(Date.now() / 1000),
                    is_first_trade: isFirstTrade,
                    replay_session_id: tradingState.replaySessionId,
                    replay_start_time: tradingState.replayStartTime,
                    bars_count: tradingState.barsCount,
                    client_id: 'tv_proxy',
                    user_id: 'public_user'
                };

                try {
                    const response = await fetch('/save-trade', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(tradeData)
                    });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        console.log('äº¤æ˜“è®°å½•ä¿å­˜æˆåŠŸ');
                        if (isFirstTrade && data.data && data.data.session_uuid) {
                            tradingState.replaySessionId = data.data.session_uuid;
                            console.log('æ–°å›æ”¾ä¼šè¯å·²åˆ›å»ºï¼ŒID:', tradingState.replaySessionId);
                        }
                    } else {
                        console.error('äº¤æ˜“è®°å½•ä¿å­˜å¤±è´¥:', data.message);
                    }
                } catch (error) {
                    console.error('ä¿å­˜äº¤æ˜“è®°å½•æ—¶å‡ºé”™:', error);
                }
            }

            // è®°å½•å¸‚åœºä»·æ ¼çš„å‡½æ•°
            async function recordMarketPrice(priceType) {
                if (!tradingState.replaySessionId) {
                    // å¦‚æœè¿˜æ²¡æœ‰å›æ”¾ä¼šè¯IDï¼Œéœ€è¦å…ˆåˆ›å»ºä¼šè¯
                    await createReplaySession();
                }

                if (!tradingState.replaySessionId) {
                    console.error('æ— æ³•è®°å½•å¸‚åœºä»·æ ¼ï¼šç¼ºå°‘å›æ”¾ä¼šè¯ID');
                    return;
                }

                try {
                    const currentPrice = await getCurrentPrice();
                    if (!currentPrice) {
                        console.error('æ— æ³•è·å–å½“å‰å¸‚åœºä»·æ ¼');
                        return;
                    }

                    const response = await fetch(`/api/replay/sessions/${tradingState.replaySessionId}/market-price`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            price: currentPrice,
                            price_type: priceType
                        })
                    });

                    const data = await response.json();
                    if (data.status === 'ok') {
                        console.log(`å¸‚åœº${priceType === 'start' ? 'èµ·å§‹' : 'ç»“æŸ'}ä»·æ ¼è®°å½•æˆåŠŸ:`, currentPrice);
                    } else {
                        console.error('è®°å½•å¸‚åœºä»·æ ¼å¤±è´¥:', data.message);
                    }
                } catch (error) {
                    console.error('è®°å½•å¸‚åœºä»·æ ¼æ—¶å‡ºé”™:', error);
                }
            }

            // ç»“æŸå½“å‰å›æ”¾ä¼šè¯çš„å‡½æ•°
            async function finishCurrentReplaySession() {
                if (!tradingState.replaySessionId) {
                    return; // æ²¡æœ‰æ´»è·ƒçš„ä¼šè¯
                }

                console.log('ç»“æŸå½“å‰å›æ”¾ä¼šè¯:', tradingState.replaySessionId);
                
                try {
                    // è®°å½•å¸‚åœºç»“æŸä»·æ ¼å’Œç»“æŸæ—¶é—´
                    await recordMarketPrice('end');
                    
                    // æ›´æ–°ä¼šè¯çš„ç»“æŸæ—¶é—´
                    const response = await fetch(`/api/replay/sessions/${tradingState.replaySessionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            end_time: Math.floor(Date.now() / 1000)
                        })
                    });

                    const data = await response.json();
                    if (data.status === 'ok') {
                        console.log('å›æ”¾ä¼šè¯ç»“æŸæ—¶é—´æ›´æ–°æˆåŠŸ');
                    } else {
                        console.error('æ›´æ–°å›æ”¾ä¼šè¯ç»“æŸæ—¶é—´å¤±è´¥:', data.message);
                    }
                } catch (error) {
                    console.error('ç»“æŸå›æ”¾ä¼šè¯æ—¶å‡ºé”™:', error);
                }

                // æ¸…é™¤å½“å‰ä¼šè¯IDï¼Œä¸ºæ–°ä¼šè¯åšå‡†å¤‡
                tradingState.replaySessionId = null;
            }

            // åˆ›å»ºå›æ”¾ä¼šè¯çš„å‡½æ•°
            async function createReplaySession() {
                if (tradingState.replaySessionId) {
                    return; // å·²ç»æœ‰ä¼šè¯IDäº†
                }

                try {
                    const chart = window.widget.chart();
                    const symbol_interval = window.widget.symbolInterval();
                    const symbol = symbol_interval.symbol;
                    const interval = symbol_interval.interval;

                    const sessionData = {
                        symbol: symbol,
                        interval: interval,
                        start_time: tradingState.replayStartTime,
                        bars_count: tradingState.barsCount,
                        client_id: 'tv_proxy',
                        user_id: 'public_user'
                    };

                    const response = await fetch('/api/replay/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData)
                    });

                    const data = await response.json();
                    if (data.status === 'ok' && data.data && data.data.session_uuid) {
                        tradingState.replaySessionId = data.data.session_uuid;
                        console.log('å›æ”¾ä¼šè¯åˆ›å»ºæˆåŠŸï¼ŒID:', tradingState.replaySessionId);
                    } else {
                        console.error('åˆ›å»ºå›æ”¾ä¼šè¯å¤±è´¥:', data.message);
                    }
                } catch (error) {
                    console.error('åˆ›å»ºå›æ”¾ä¼šè¯æ—¶å‡ºé”™:', error);
                }
            }
        })();
    </script>
</body>

</html>